<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Time</title><style type="text/css">body{
margin:40px auto;
max-width:650px;
line-height:1.6;
font-size:18px;
color:#eee;
background-color:#111;
padding:0 10px
}
textarea, input, button {
color:#eee;
background-color:#111;
}
button:hover {
  background-color:#222;
}
:root {
  --thin-border: solid 0.125ex;
}
.button-container {
  padding: 0;
  margin: 0;
  display: flex;
  justify-content: space-between;
}
.category-controls {
  display: inline-flex;
  flex-direction: column;
  gap: 0.5ex;
}
.seven-columns {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
  width: 100%;
  text-align: center;
}
.other-month {
  color: #888;
}
.current-month {}
.current-day {
    border: var(--thin-border);
}
.thin-border {
    border: var(--thin-border);
}
.thin-border-row {
    border-top: var(--thin-border);
    border-bottom: var(--thin-border);
}
.month-label {
    text-align: center;
    font-size: 21px;
    font-weight: 700;
}
.center-text {
    text-align: center
}
.calendar-type-label {
    text-align: right;
    font-size: 12px;
    font-weight: 700;
    margin-right: 0.5rem;
    /* Move up into the space of the month label */
    margin-top: -2ex;
}
.digital {
    color: #5a7d8b;
    font-size: 60px;
    font-family: monospace;
    letter-spacing: 7px;
}
.digital-small {
    color: #5a7d8b;
    font-size: 48px;
    font-family: monospace;
    letter-spacing: 7px;
}
.verbal {
    color: #5a7d8b;
    font-size: 48px; /* Small enough to fit "Twenty-Five past Eleven" on one line */
    font-family: cursive;
    letter-spacing: 7px;
}
.clock-row {
    display: inline-flex;
    margin-bottom: 1ex;
}
.labelled-row {
    margin-bottom: 1ex;
}
.labelled-row-label {
    color: #5a7d8b;
    text-align: right;
    font-size: 12px;
    font-weight: 700;
    margin-right: 0.5rem;
    /* Move up into the space of the season text */
    margin-top: -6ex;
    margin-bottom: 0;
}
</style>
</head>

<body>
    <div>
        <div class="button-container">
            <button type="button" id="minus">−</button>
            <button type="button" id="play-pause">&#x23EF;</button>
            <button type="button" id="plus">+</button>
        </div>
        <input id="selected-time" type="range" style="width: 100%;" />
        <input id="selected-time-number" type="number" />
        <output id="displayed-step"></output>
        <details>
            <summary>
                Subset Controls
            </summary>
            <div style="display: grid;">
                <input id="subset-number" type="number" />
                <span>
                    <button id="subset-shift-up"> &lt;&lt; </button>
                    <button id="subset-shift-down"> &gt;&gt; </button>
                    <span class="category-controls">
                        <span class="center-text">digital</span>
                        <button id="remove-digital"> &amp;~ </button>
                        <button id="digital-only"> = </button>
                        <button id="add-digital"> | </button>
                    </span>
                    <span class="category-controls">
                        <span class="center-text">analogue</span>
                        <button id="remove-analogue"> &amp;~ </button>
                        <button id="analogue-only"> = </button>
                        <button id="add-analogue"> | </button>
                    </span>
                    <span class="category-controls">
                        <span class="center-text">calendars</span>
                        <button id="remove-calendars"> &amp;~ </button>
                        <button id="calendars-only"> = </button>
                        <button id="add-calendars"> | </button>
                    </span>
                    <span class="category-controls">
                        <span class="center-text">week numbers</span>
                        <button id="remove-week-numbers"> &amp;~ </button>
                        <button id="week-numbers-only"> = </button>
                        <button id="add-week-numbers"> | </button>
                    </span>
                    <span class="category-controls">
                        <span class="center-text">week cards</span>
                        <button id="remove-week-cards"> &amp;~ </button>
                        <button id="week-cards-only"> = </button>
                        <button id="add-week-cards"> | </button>
                    </span>
                </span>
            </div>
        </details>
        <div style="display: grid;">
            <output id="raw"></output>
            <output id="utc-string"></output>
            <div class="clock-row">
                <output class="digital" id="digital-clock-12"></output>
                <canvas width=0 height=0 id="analogue-clock-12">
                    A standard analogue clock.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-24"></output>
                <canvas width=0 height=0 id="analogue-clock-24">
                    A 24-hour analogue clock.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-base-12"></output>
                <canvas width=0 height=0 id="analogue-clock-base-12">
                    A standard analogue clock with X, E, and 10 instead of 10, 11 and 12 respevtively.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-24-base-12"></output>
                <canvas width=0 height=0 id="analogue-clock-24-base-12">
                    A 24-hour analogue clock with X, E, and 10 instead of 10, 11 and 12 respevtively, and so on up to 23 being 1E, and 24 being 20.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-base-factorial"></output>
                <canvas width=0 height=0 id="analogue-clock-base-factorial">
                    A standard analogue clock that uses the factorial number system (sans trailing 0) to represent the numbers from 1 to 12
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-24-base-factorial"></output>
                <canvas width=0 height=0 id="analogue-clock-24-base-factorial">
                    A 24-hour analogue clock that uses the factorial number system (sans trailing 0) to represent the numbers from 1 to 24
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="verbal-clock"></output>
                <canvas width=0 height=0 id="analogue-clock-verbal">
                    A standard analogue clock that uses words instead of numbers
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="verbal-clock-24"></output>
                <canvas width=0 height=0 id="analogue-clock-verbal-24">
                    A 24-hour analogue clock that uses words instead of numbers
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="verbal-time"></output>
            </div>
            <div class="clock-row">
                <canvas width=0 height=0 id="analogue-clock-12-0-offset">
                    A standard analogue clock but rotated so that the 12 is on the far right.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="analogue-clock-emoji"></output>
                <canvas width=0 height=0 id="analogue-clock-emoji-numbers">
                    A standard analogue clock that uses analogue clock emoji instead of numbers
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="chinese-telegraph-month-day-hour"></output>
                <canvas width=0 height=0 id="analogue-clock-chinese-telegraph">
                    A standard analogue clock that uses chinese telegraph hour symbols instead of numbers
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="chinese-telegraph-month-day-hour-24"></output>
                <canvas width=0 height=0 id="analogue-clock-chinese-telegraph-24">
                    A 24-hour analogue clock that uses chinese telegraph hour symbols instead of numbers
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="chinese-telegraph-digits-month-day-hour"></output>
            </div>
            <div class="clock-row">
                <output class="verbal" id="verbal-english-weekday"></output>
            </div>
            <div id="week-number-first-friday-row" class="labelled-row">
                <output class="verbal" id="week-number-first-friday"></output>
                <div class="labelled-row-label" > (Starts on Saturday before first Friday) </div>
            </div>
            <div id="week-number-first-saturday-row" class="labelled-row">
                <output class="verbal" id="week-number-first-saturday"></output>
                <div class="labelled-row-label" > (Starts on Sunday before first Saturday) </div>
            </div>
            <div id="week-number-first-sunday-row" class="labelled-row">
                <output class="verbal" id="week-number-first-sunday"></output>
                <div class="labelled-row-label" > (Starts on Monday before first Sunday) </div>
            </div>
            <div id="week-number-iso-8601-row" class="labelled-row">
                <output class="verbal" id="week-number-iso-8601"></output>
                <div class="labelled-row-label" > (ISO 8601) </div>
            </div>
            <div id="week-number-ifc-row" class="labelled-row">
                <output class="verbal" id="week-number-ifc"></output>
                <div class="labelled-row-label" > (International Fixed Calendar) </div>
            </div>
            <div id="week-card-first-friday-row" class="labelled-row">
                <output class="verbal" id="week-card-first-friday"></output>
                <div class="labelled-row-label" > (Starts on Saturday before first Friday) </div>
            </div>
            <div id="week-card-first-saturday-row" class="labelled-row">
                <output class="verbal" id="week-card-first-saturday"></output>
                <div class="labelled-row-label" > (Starts on Sunday before first Saturday) </div>
            </div>
            <div id="week-card-first-sunday-row" class="labelled-row">
                <output class="verbal" id="week-card-first-sunday"></output>
                <div class="labelled-row-label" > (Starts on Monday before first Sunday) </div>
            </div>
            <div id="week-card-iso-8601-row" class="labelled-row">
                <output class="verbal" id="week-card-iso-8601"></output>
                <div class="labelled-row-label" > (ISO 8601) </div>
            </div>
            <div id="week-card-ifc-row" class="labelled-row">
                <output class="verbal" id="week-card-ifc"></output>
                <div class="labelled-row-label" > (International Fixed Calendar) </div>
            </div>
            <div id="gregorian-dominical-letters-row" class="labelled-row">
                <output class="verbal" id="gregorian-dominical-letters"></output>
                <div class="labelled-row-label" > (Gregorian Dominical Letters for Year) </div>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-date"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-date-base-day-of-month-plus-one"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-ifc-date-base-day-of-month-plus-one"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-date-base-factorial"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-ifc-date-base-factorial"></output>
            </div>
            <div id="metrological-seasons-north-row" class="labelled-row">
                <output class="verbal" id="metrological-seasons-north"></output>
                <div class="labelled-row-label" > (metrological; northern hemisphere) </div>
            </div>
            <div id="metrological-seasons-south-row" class="labelled-row">
                <output class="verbal" id="metrological-seasons-south"></output>
                <div class="labelled-row-label" > (metrological; southern hemisphere) </div>
            </div>
            <div id="synodic-month-row" class="labelled-row">
                <output class="digital-small" id="synodic-month"></output>
                <div class="labelled-row-label"> Synodic Months relative to the Epoch </div>
            </div>
            <div id="tropical-month-row" class="labelled-row">
                <output class="digital-small" id="tropical-month"></output>
                <div class="labelled-row-label"> Tropical Months relative to the Epoch </div>
            </div>
            <div id="sideral-month-row" class="labelled-row">
                <output class="digital-small" id="sideral-month"></output>
                <div class="labelled-row-label"> Sideral Months relative to the Epoch </div>
            </div>
            <div id="anomalistic-month-row" class="labelled-row">
                <output class="digital-small" id="anomalistic-month"></output>
                <div class="labelled-row-label"> Anomalistic Months relative to the Epoch </div>
            </div>
            <div id="dragonic-month-row" class="labelled-row">
                <output class="digital-small" id="dragonic-month"></output>
                <div class="labelled-row-label"> Dragonic Months relative to the Epoch </div>
            </div>
            <div id="gregorian-calendar" class="thin-border">
                <div id="gregorian-calendar-month" class="month-label"> January </div>
                <div class="calendar-type-label" > Gregorian </div>
                <div id="gregorian-calendar-week-labels" class="seven-columns thin-border-row">
                    <div> Sun </div>
                    <div> Mon </div>
                    <div> Tue </div>
                    <div> Wed </div>
                    <div> Thu </div>
                    <div> Fri </div>
                    <div> Sat </div>
                </div>
                <div id="gregorian-calendar-boxes" class="seven-columns">
                </div>
                <div id="gregorian-calendar-extra-label" class="thin-border-row center-text" style="display: none">
                </div>
                <div id="gregorian-calendar-extra-boxes" class="seven-columns" style="display: none">
                </div>
            </div>
            <div id="international-fixed-calendar", class="thin-border">
                <div id="international-fixed-calendar-month" class="month-label"> January </div>
                <div class="calendar-type-label"> International Fixed</div>
                <div id="international-fixed-calendar-week-labels" class="seven-columns thin-border-row">
                    <div> Sun </div>
                    <div> Mon </div>
                    <div> Tue </div>
                    <div> Wed </div>
                    <div> Thu </div>
                    <div> Fri </div>
                    <div> Sat </div>
                </div>
                <div id="international-fixed-calendar-boxes" class="seven-columns">
                </div>
                <div id="international-fixed-calendar-extra-label" class="thin-border-row center-text" style="display: none">
                </div>
                <div id="international-fixed-calendar-extra-boxes" class="seven-columns" style="display: none">
                </div>
            </div>
        </div>
    </div>
    <script src="factorialBase.js"></script>
    <script src="time.js"></script>
    <script>
        const DEBUG_MODE = location.protocol === "file:"
        if (DEBUG_MODE) {
            console.log("DEBUG_MODE = " + DEBUG_MODE)
        }

        const displayedStep = document.getElementById("displayed-step");
        const raw = document.getElementById("raw");
        const utcString = document.getElementById("utc-string");
        const inputRange = document.getElementById("selected-time");
        const inputNumber = document.getElementById("selected-time-number");

        const subsetNumber = document.getElementById("subset-number");

        const TIMEPIECE_IDS = [
            "digital-clock-12",
            "analogue-clock-12",
            "digital-clock-24",
            "analogue-clock-24",
            "digital-clock-base-12",
            "analogue-clock-base-12",
            "digital-clock-24-base-12",
            "analogue-clock-24-base-12",
            "digital-clock-base-factorial",
            "analogue-clock-base-factorial",
            "digital-clock-24-base-factorial",
            "analogue-clock-24-base-factorial",
            "verbal-clock",
            "analogue-clock-verbal",
            "verbal-clock-24",
            "analogue-clock-verbal-24",
            "verbal-time",
            "analogue-clock-12-0-offset",
            "analogue-clock-emoji",
            "analogue-clock-emoji-numbers",
            "chinese-telegraph-month-day-hour",
            "analogue-clock-chinese-telegraph",
            "chinese-telegraph-month-day-hour-24",
            "analogue-clock-chinese-telegraph-24",
            "chinese-telegraph-digits-month-day-hour",
            "verbal-english-weekday",
            "week-number-first-friday-row",
            "week-number-first-saturday-row",
            "week-number-first-sunday-row",
            "week-number-iso-8601-row",
            "week-number-ifc-row",
            "week-card-first-friday-row",
            "week-card-first-saturday-row",
            "week-card-first-sunday-row",
            "week-card-iso-8601-row",
            "week-card-ifc-row",
            "gregorian-dominical-letters-row",
            "digital-date",
            "digital-date-base-day-of-month-plus-one",
            "digital-ifc-date-base-day-of-month-plus-one",
            "digital-date-base-factorial",
            "digital-ifc-date-base-factorial",
            "metrological-seasons-north-row",
            "metrological-seasons-south-row",
            "synodic-month-row",
            "tropical-month-row",
            "sideral-month-row",
            "anomalistic-month-row",
            "dragonic-month-row",
            "gregorian-calendar",
            "international-fixed-calendar",
        ]

        const ALL_TIMEPIECES_SUBSET = (1n << BigInt(TIMEPIECE_IDS.length)) - 1n
        subsetNumber.value = ALL_TIMEPIECES_SUBSET

        const subsetThatContains = (substr) => {
            let subset = 0n
            let bit = 1n
            for (let id of TIMEPIECE_IDS) {
                if (id.includes(substr)) {
                    subset |= bit
                }
                bit <<= 1n
            }
            return subset
        }

        const setupCatergoryControls = ({addID, onlyID, removeID, subset}) => {
            const add = document.getElementById(addID);
            const onAdd = () => {
                setSubsetMask(getCurrentSubsetMask() | subset)
            }
            add.onclick = onAdd

            const only = document.getElementById(onlyID);
            const onOnly = () => {
                setSubsetMask(subset)
            }
            only.onclick = onOnly

            const remove = document.getElementById(removeID);
            const onRemove = () => {
                setSubsetMask(getCurrentSubsetMask() & ~subset)
            }
            remove.onclick = onRemove
        };

        setupCatergoryControls({
            addID: "add-digital",
            onlyID: "digital-only",
            removeID: "remove-digital",
            subset: subsetThatContains("digital"),
        });

        setupCatergoryControls({
            addID: "add-analogue",
            onlyID: "analogue-only",
            removeID: "remove-analogue",
            subset: subsetThatContains("analogue"),
        });

        setupCatergoryControls({
            addID: "add-calendars",
            onlyID: "calendars-only",
            removeID: "remove-calendars",
            subset: subsetThatContains("calendar"),
        });

        setupCatergoryControls({
            addID: "add-week-numbers",
            onlyID: "week-numbers-only",
            removeID: "remove-week-numbers",
            subset: subsetThatContains("week-number"),
        });

        setupCatergoryControls({
            addID: "add-week-cards",
            onlyID: "week-cards-only",
            removeID: "remove-week-cards",
            subset: subsetThatContains("week-card"),
        });


        const setSubsetMask = (mask) => {
            subsetNumber.value = mask

            for (let i = 0n; i < TIMEPIECE_IDS.length; i += 1n) {
                const element = document.getElementById(TIMEPIECE_IDS[i])
                if ((mask & (1n << i)) !== 0n) {
                    element.style.display = "unset";
                } else {
                    element.style.display = "none";
                }
            }
        }

        const getCurrentSubsetMask = () => {
            let subset
            try {
                subset = BigInt(subsetNumber.value)
            } catch (e) {
                if (DEBUG_MODE) {
                    console.log(e)
                }
                subset = ALL_TIMEPIECES_SUBSET
            }
            return subset
        }

        const onSubsetChange = () => {
            setSubsetMask(getCurrentSubsetMask())
        }
        subsetNumber.oninput = onSubsetChange

        const subsetShiftUp = document.getElementById("subset-shift-up");
        const onShiftUp = () => {
            setSubsetMask(getCurrentSubsetMask() << 1n)
        }
        subsetShiftUp.onclick = onShiftUp

        const subsetShiftDown = document.getElementById("subset-shift-down");
        const onShiftDown = () => {
            setSubsetMask(getCurrentSubsetMask() >> 1n)
        }
        subsetShiftDown.onclick = onShiftDown

        const startTime = new Date().getTime()
        const TIME_ROUND_TO = 1_000_000_000_000

        const defaultLowEdge = Math.floor(startTime / TIME_ROUND_TO) * TIME_ROUND_TO
        const defaultHighEdge = Math.ceil(startTime / TIME_ROUND_TO) * TIME_ROUND_TO

        inputRange.min = inputNumber.min = defaultLowEdge
        inputRange.max = inputNumber.max = defaultHighEdge
        const setStep = (step) => {
            inputRange.step = inputNumber.step = step
            if (step === 1) {
                displayedStep.textContent = ''
            } else {
                displayedStep.textContent = "movement ×" + step.toLocaleString() + " " + humanReadableSIDurationFromMillis(step)
            }
        }
        const setFromTime = (time) => {
            inputRange.value = inputNumber.value = time
        }
        setFromTime(startTime)

        const RUNNING = "running"
        const PAUSED = "paused"

        let inputMode = RUNNING
        const onInput = () => {
            inputMode = PAUSED
            // TODO? Are we gonna want to debounce this?
            const v = event.target.value
            const parsed = parseInt(v)

            const min = parseInt(inputRange.min)
            const max = parseInt(inputRange.max)

            let time
            if (Number.isNaN(parsed) || parsed < min) {
                time = min
            } else if (parsed > max) {
                time = max
            } else {
                time = parsed
            }

            renderAt(new Date(time))
        }
        inputRange.oninput = inputNumber.oninput = onInput

        let moveListener;
        let startClientY;
        inputRange.addEventListener("pointerdown", (e) => {
            startClientY = e.clientY

            l = inputRange.addEventListener("pointermove", (e) => {
              const yDelta = Math.abs(startClientY - e.clientY)

              const PIXELS_PER_STEP = 16;
              const rawStep = Math.pow(10, Math.floor(yDelta/PIXELS_PER_STEP))

              const range = parseInt(inputRange.max) - parseInt(inputRange.min)

              setStep(Math.min(rawStep, range))
            });
        });
        inputRange.addEventListener("pointerup", (e) => {
            inputRange.removeEventListener("pointermove", moveListener)

            // Avoid jittering the input when releasing
            const selectedValue = inputRange.value
            setTimeout(() => setFromTime(selectedValue), 8)
        });

        const minus = document.getElementById("minus");
        minus.onclick = () => {
            inputRange.min = inputNumber.min = parseInt(inputRange.min) - TIME_ROUND_TO
        };

        const plus = document.getElementById("plus");
        plus.onclick = () => {
            inputRange.max = inputNumber.max = parseInt(inputRange.max) + TIME_ROUND_TO
        };

        const gregorianCalendarElements = {
            monthLabel: document.getElementById("gregorian-calendar-month"),
            weekLabels: document.getElementById("gregorian-calendar-week-labels"),
            boxes: document.getElementById("gregorian-calendar-boxes"),
            extraBoxesLabel: document.getElementById("gregorian-calendar-extra-label"),
            extraBoxes: document.getElementById("gregorian-calendar-extra-boxes"),
        };
        const internationalFixedCalendarElements = {
            monthLabel: document.getElementById("international-fixed-calendar-month"),
            weekLabels: document.getElementById("international-fixed-calendar-week-labels"),
            boxes: document.getElementById("international-fixed-calendar-boxes"),
            extraBoxesLabel: document.getElementById("international-fixed-calendar-extra-label"),
            extraBoxes: document.getElementById("international-fixed-calendar-extra-boxes"),
        };

        let clockLengthsMemo = {}

        const clockLengths = (scale) => {
            scale ||= 1

            // TODO? Measure whether memoizing this was actually worth it?
            if (!clockLengthsMemo[scale]) {
                const clockWidth = 100 * scale
                const clockHeight = 100 * scale
                const clockX = clockWidth/2
                const clockY = clockHeight/2
                const clockRadius = clockWidth * 0.45
                const clockNumberRadius = clockWidth * 0.375
                const clockInnerEdgeRadius = clockRadius * 0.95
                const clockSecondRadius = clockInnerEdgeRadius * 0.975
                const clockMinuteRadius = clockInnerEdgeRadius * 0.95
                const clockHourRadius = clockInnerEdgeRadius * 0.65

                clockLengthsMemo[scale] = {
                    clockWidth,
                    clockHeight,
                    clockX,
                    clockY,
                    clockRadius,
                    clockNumberRadius,
                    clockInnerEdgeRadius,
                    clockSecondRadius,
                    clockMinuteRadius,
                    clockHourRadius,
                }
            }

            return clockLengthsMemo[scale]
        }

        const digitalClock12 = document.getElementById("digital-clock-12")
        const digitalClock24 = document.getElementById("digital-clock-24")
        const digitalClockBase12 = document.getElementById("digital-clock-base-12")
        const digitalClock24Base12 = document.getElementById("digital-clock-24-base-12")
        const digitalClockBaseFactorial = document.getElementById("digital-clock-base-factorial")
        const digitalClock24BaseFactorial = document.getElementById("digital-clock-24-base-factorial")


        const verbalClock = document.getElementById("verbal-clock")
        const verbalClock24 = document.getElementById("verbal-clock-24")
        const verbalTime = document.getElementById("verbal-time")
        const verbalEnglishWeekday = document.getElementById("verbal-english-weekday")
        const weekNumberFirstFriday = document.getElementById("week-number-first-friday")
        const weekNumberFirstSaturday = document.getElementById("week-number-first-saturday")
        const weekNumberFirstSunday = document.getElementById("week-number-first-sunday")
        const weekNumberISO8601 = document.getElementById("week-number-iso-8601")
        const weekNumberIFC = document.getElementById("week-number-ifc")
        const weekCardFirstFriday = document.getElementById("week-card-first-friday")
        const weekCardFirstSaturday = document.getElementById("week-card-first-saturday")
        const weekCardFirstSunday = document.getElementById("week-card-first-sunday")
        const weekCardISO8601 = document.getElementById("week-card-iso-8601")
        const weekCardIFC = document.getElementById("week-card-ifc")
        const gregorianDominicalLetters = document.getElementById("gregorian-dominical-letters")
        const digitalDate = document.getElementById("digital-date")
        const digitalDateBaseDayOfMonthPlusOne = document.getElementById("digital-date-base-day-of-month-plus-one")
        const digitalIFCDateBaseDayOfMonthPlusOne = document.getElementById("digital-ifc-date-base-day-of-month-plus-one")
        const digitalDateBaseFactorial = document.getElementById("digital-date-base-factorial")
        const digitalIFCDateBaseFactorial = document.getElementById("digital-ifc-date-base-factorial")
        const analogueClockEmoji = document.getElementById("analogue-clock-emoji")
        const chineseTelegraphMDH = document.getElementById("chinese-telegraph-month-day-hour")
        const chineseTelegraphMDH24 = document.getElementById("chinese-telegraph-month-day-hour-24")
        const chineseTelegraphDigitsMDH = document.getElementById("chinese-telegraph-digits-month-day-hour")


        const metrologicalSeasonsNorth = document.getElementById("metrological-seasons-north")
        const metrologicalSeasonsSouth = document.getElementById("metrological-seasons-south")

        const synodicMonth = document.getElementById("synodic-month")
        const tropicalMonth = document.getElementById("tropical-month")
        const sideralMonth = document.getElementById("sideral-month")
        const anomalisticMonth = document.getElementById("anomalistic-month")
        const dragonicMonth = document.getElementById("dragonic-month")

        // Month durations as written in
        // https://archive.org/details/astronomicalalmanac1961/page/n117/mode/1up
        const SYNODIC_MONTH_IN_MILLIS =
            29 * Time.DAY_IN_MILLIS
            + 12 * Time.HOUR_IN_MILLIS
            + 44 * Time.MINUTE_IN_MILLIS
            + 2 * Time.SECOND_IN_MILLIS
            + 900

        const TROPICAL_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 7 * Time.HOUR_IN_MILLIS
            + 43 * Time.MINUTE_IN_MILLIS
            + 4 * Time.SECOND_IN_MILLIS
            + 700

        const SIDERAL_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 7 * Time.HOUR_IN_MILLIS
            + 43 * Time.MINUTE_IN_MILLIS
            + 11 * Time.SECOND_IN_MILLIS
            + 500

        const ANOMALISTIC_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 13 * Time.HOUR_IN_MILLIS
            + 18 * Time.MINUTE_IN_MILLIS
            + 33 * Time.SECOND_IN_MILLIS
            + 200

        const DRAGONIC_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 05 * Time.HOUR_IN_MILLIS
            + 05 * Time.MINUTE_IN_MILLIS
            + 35 * Time.SECOND_IN_MILLIS
            + 800

        const toAtMost10Chars = (n) => {
            if (n > 999_999_999) {
                return ">999999999"
            }
            if (n < -99_999_999) {
                return "<-999999999"
            }

            // Eight to allow for the minus sign and decimal point
            const eightSigFigs = n.toPrecision(8)

            if (eightSigFigs.includes("e")) {
                if (eightSigFigs.endsWith("e-7")) {
                    if (n > 0) {
                        return "0.000000" + eightSigFigs.substring(0, 1)
                    } else {
                        return "-0.000000" + eightSigFigs.substring(0, 1)
                    }
                }
                if (n > 0) {
                    return "0.0000001"
                } else {
                    return "-0.0000001"
                }
            }

            if (eightSigFigs.length > 10) {
                return eightSigFigs.substring(0,9)
            }

            return eightSigFigs
        }

        const getAnalogueClockCtx = (id, scale) => {
            scale ||= 1

            const lengths = clockLengths(scale)

            const canvas = document.getElementById(id)
            canvas.width = lengths.clockWidth
            canvas.height = lengths.clockHeight
            return {
                ctx: canvas.getContext("2d"),
                scale,
            };
        }

        const analogueClock12Ctx = getAnalogueClockCtx("analogue-clock-12")
        const analogueClock24Ctx = getAnalogueClockCtx("analogue-clock-24")
        const analogueClockBase12Ctx = getAnalogueClockCtx("analogue-clock-base-12")
        const analogueClock24Base12Ctx = getAnalogueClockCtx("analogue-clock-24-base-12")
        const analogueClockBaseFactorialCtx = getAnalogueClockCtx("analogue-clock-base-factorial")
        const analogueClock24BaseFactorialCtx = getAnalogueClockCtx("analogue-clock-24-base-factorial", 2)
        const analogueClockVerbalCtx = getAnalogueClockCtx("analogue-clock-verbal", 2)
        const analogueClockVerbal24Ctx = getAnalogueClockCtx("analogue-clock-verbal-24", 2)
        const analogueClock12ZeroOffsetCtx = getAnalogueClockCtx("analogue-clock-12-0-offset")
        const analogueClockEmojiNumbersCtx = getAnalogueClockCtx("analogue-clock-emoji-numbers", 2)
        const analogueClockChineseTelegraphCtx = getAnalogueClockCtx("analogue-clock-chinese-telegraph", 2)
        const analogueClockChineseTelegraph24Ctx = getAnalogueClockCtx("analogue-clock-chinese-telegraph-24", 2)


        const setFromTimeAndRender = (time) => {
            inputMode = PAUSED
            setFromTime(time)
            renderAt(new Date(time))
        }

        const clockNumberCenterXYForRadians = (radians, scale, radiusScale, xOffset) => {
            scale ||= 1
            radiusScale ||= 1
            xOffset ||= 1
            const lengths = clockLengths(scale)
            return [
                (lengths.clockX + Math.cos(radians) * lengths.clockNumberRadius * radiusScale) + (xOffset * scale),
                lengths.clockY + Math.sin(radians) * lengths.clockNumberRadius * radiusScale,
            ]
        };

        function lastBase12Digit(x){
            x = Math.floor(x)
            x %= 12
            switch (x) {
                case 10:
                    return 'X'
                case 11:
                    return 'E'
                default:
                    return String(x)
            }
        }

        const clockTextForIndex = (index, divisor) => "" + (index === 0 ? divisor : index);

        const base12TextForIndex = (index, divisor) => {
            let n = index === 0 ? divisor : index

            let output = ""
            // Takes advantage of n being known to not be 0
            while (n > 0) {
                output = lastBase12Digit(n) + output

                n /= 12
                n = Math.floor(n)
            }

            return output
        }

        const factorialTextForIndex = (index, divisor) => {
            const n = index === 0 ? divisor : index

            return FactorialBase.stringOf(n)
        }

        const wordForIndex = (index, divisor) => {
            const n = index === 0 ? divisor : index

            return intToWords(n)
        }


        const TAU = 2 * Math.PI

        const clockNumberCenterXYForIndex = ({index, divisor, offset, scale, radiusScale, xOffset}) => {
            // Note that the negatives here do happen to work out
            offset = offset === undefined ? -3 : offset
            return clockNumberCenterXYForRadians(
                ((index + offset) % divisor) * (TAU / divisor),
                scale,
                radiusScale,
                xOffset
            )
        }

        const humanReadableSIDurationFromMillis = (millis) => {
            if (millis < Time.SECOND_IN_MILLIS) {
                return "less than a second"
            }

            const totalSeconds = Math.floor(millis / Time.SECOND_IN_MILLIS)
            const remainingSeconds = totalSeconds % 60

            const totalMinutes = Math.floor(millis / Time.MINUTE_IN_MILLIS)
            const remainingMinutes = totalMinutes % 60

            const totalHours = Math.floor(millis / Time.HOUR_IN_MILLIS)
            const remainingHours = totalHours % 24

            const totalDays = Math.floor(millis / Time.DAY_IN_MILLIS)
            const remainingDays = totalDays % 365.25

            const totalYears = Math.floor(millis / Time.SI_YEAR_IN_MILLIS)
            const remainingYears = totalYears % 1000

            const totalMillenia = Math.floor(millis / Time.SI_MILLIENUM_IN_MILLIS)
            const remainingMillenia = totalMillenia % 1000

            const totalMegaannus = Math.floor(millis / Time.SI_MEGAANNUM_IN_MILLIS)
            const remainingMegaannus = totalMegaannus % 1000

            const totalGigaannus = Math.floor(millis / Time.SI_GIGAANNUM_IN_MILLIS)
            const remainingGigaannus = totalGigaannus % 1000

            const totalTeraannus = Math.floor(millis / Time.SI_TERAANNUM_IN_MILLIS)
            const remainingTeraannus = totalTeraannus % 1000

            const totalPetaannus = Math.floor(millis / Time.SI_PETAANNUM_IN_MILLIS)
            const remainingPetaannus = totalPetaannus % 1000

            const totalExaannus = Math.floor(millis / Time.SI_EXAANNUM_IN_MILLIS)
            const remainingExaannus = totalExaannus % 1000

            const totalZetaannus = Math.floor(millis / Time.SI_ZETAANNUM_IN_MILLIS)
            const remainingZetaannus = totalZetaannus % 1000

            const totalYottaannus = Math.floor(millis / Time.SI_YOTTAANNUM_IN_MILLIS)

            // Some of these units exceed the integer precision of double precision floating point

            return [
                (totalYottaannus > 0 ? (totalYottaannus === 1 ? "1 yottaannum" : totalYottaannus + " yottaannus") : ""),
                (remainingZetaannus > 0 ? (remainingZetaannus === 1 ? "1 zetaannum" : remainingZetaannus + " zetaannus") : ""),
                (remainingExaannus > 0 ? (remainingExaannus === 1 ? "1 exaannum" : remainingExaannus + " exaannus") : ""),
                (remainingPetaannus > 0 ? (remainingPetaannus === 1 ? "1 teraannum" : remainingPetaannus + " teraannus") : ""),
                (remainingTeraannus > 0 ? (remainingTeraannus === 1 ? "1 teraannum" : remainingTeraannus + " teraannus") : ""),
                (remainingGigaannus > 0 ? (remainingGigaannus === 1 ? "1 gigaannum" : remainingGigaannus + " gigaannus") : ""),
                (remainingMegaannus > 0 ? (remainingMegaannus === 1 ? "1 megaannum" : remainingMegaannus + " megaannus") : ""),
                (remainingMillenia > 0 ? (remainingMillenia === 1 ? "1 millienium" : remainingMillenia + " millienia") : ""),
                (remainingYears > 0 ? (remainingYears === 1 ? "1 year" : remainingYears + " years") : ""),
                (remainingDays > 0 ? (remainingDays === 1 ? "1 day" : remainingDays + " days") : ""),
                (remainingHours > 0 ? (remainingHours === 1 ? "1 hour" : remainingHours + " hours") : ""),
                (remainingMinutes > 0 ? (remainingMinutes === 1 ? "1 minute" : remainingMinutes + " minutes") : ""),
                (remainingSeconds === 1) ? "1 second" : remainingSeconds + " seconds",
            ].filter(x => x) // empty string is falsey
            .join(", ")
        }

        const range = (n) => {
            let output = new Array(n)

            for (let i = 0; i < n; i += 1) {
                output[i] = i
            }

            return output
        }

        const range12 = range(12)
        const range24 = range(24)

        // TODO? Memoize these?
        const twelveHourClockNumberXYForIndex = (index, scale) => {
            return clockNumberCenterXYForIndex({index, divisor: 12, scale})
        }

        const twelveHourZeroOffsetClockNumberXYForIndex = (index, scale) => {
            return clockNumberCenterXYForIndex({index, divisor: 12, offset: 0, scale})
        }

        const twentyFourHourClockNumberXYForIndex = (index, scale) => {
            return clockNumberCenterXYForIndex({index, divisor: 24, offset: -6, scale})
        }

        const twentyFourHourClockVerbalXYForIndex = (index, scale) => {
            let radiusScale
            switch (index) {
                case 0:
                case 12:
                    radiusScale = 1
                break
                case 1:
                case 11:
                case 13:
                case 23:
                    radiusScale = 0.9
                break
                case 3:
                    radiusScale = 0.825
                break
                case 14:
                case 22:
                    radiusScale = 0.8
                break
                case 15:
                case 16:
                case 17:
                case 18:
                case 19:
                case 20:
                case 21:
                    radiusScale = 0.75
                break
                default:
                    radiusScale = 0.85
                break
            }
            switch (index) {
                case 1:
                    xOffset = 12
                break
                default:
                    xOffset = 0
                break
            }
            return clockNumberCenterXYForIndex({index, divisor: 24, offset: -6, scale, radiusScale, xOffset})
        }

        const twelveHourClockNumberXYs = (scale) => range12.map(n => twelveHourClockNumberXYForIndex(n, scale))
        const twelveHourZeroOffsetClockNumberXYs = (scale) => range12.map(n => twelveHourZeroOffsetClockNumberXYForIndex(n, scale))

        const twentyFourHourClockNumberXYs = (scale) => range24.map(n => twentyFourHourClockNumberXYForIndex(n, scale))
        const twentyFourHourClockVerbalNumberXYs = (scale) => range24.map(n => twentyFourHourClockVerbalXYForIndex(n, scale))

        const getDayOfWeekOfLastDayOfYear = (year) => (year + Math.floor(year/4) - Math.floor(year/100) + Math.floor(year/400)) % 7;

        const getISO8601WeekCount = (year) => {
            const hasExtra = getDayOfWeekOfLastDayOfYear(year) === 4 || getDayOfWeekOfLastDayOfYear(year - 1) === 3
            return 52 + (hasExtra ? 1 : 0)
        }

        const sundayStartWeekNumberToMondayStart = (weekNumber) => {
            // + 6 is - 1 mod 7, and this keeps us on the positive side of 0
            return (weekNumber + 6) % 7;
        }

        const getISO8601WeekNumber = (date) => {
            const year = date.getUTCFullYear()
            const sundayWeekdayNumber = date.getUTCDay()
            const weekdayNumber = sundayStartWeekNumberToMondayStart(sundayWeekdayNumber)

            const provisionalWeekNumber = Math.floor((10 + Time.get0IndexedDayOfYear(date) - weekdayNumber) / 7)

            if (provisionalWeekNumber < 1) {
                return {iso8601WeekNumber: getISO8601WeekCount(year - 1), yearOfISO8601Week: year - 1}
            } else if (provisionalWeekNumber > getISO8601WeekCount(year)) {
                return {iso8601WeekNumber: 1, yearOfISO8601Week: year + 1}
            } else {
                return {iso8601WeekNumber: provisionalWeekNumber, yearOfISO8601Week: year}
            }
        }


        const renderAt = (date) => {
            const time = date.getTime()
            setFromTime(time)
            raw.textContent = time.toLocaleString()
            utcString.textContent = date.toUTCString()

            const gregorianCalendarSpecs = Time.calculateCalendarSpecs(Time.GREGORIAN, date)

            applyCalendarSpecs(gregorianCalendarElements, gregorianCalendarSpecs)

            const internationalFixedCalendarBoxSpecs = Time.calculateCalendarSpecs(Time.INTERNATIONAL_FIXED, date)

            applyCalendarSpecs(internationalFixedCalendarElements, internationalFixedCalendarBoxSpecs)

            const hours = date.getUTCHours(); // 0 - 23
            const hours12 = hours % 12 // 0 - 11
            const minutes = date.getUTCMinutes(); // 0 - 59
            const seconds = date.getUTCSeconds(); // 0 - 59

            let h = padToTwoDigits(hours);
            let h12 = padToTwoDigits(hours12 === 0 ? 12 : hours12);
            let m = padToTwoDigits(minutes);
            let s = padToTwoDigits(seconds);

            digitalClock12.innerHTML = (hours >= 12 ? "˙" : "&nbsp;") + h12 + ":" + m + ":" + s
            digitalClock24.innerHTML = "&nbsp;" + h + ":" + m + ":" + s
            digitalClockBase12.innerHTML = (hours >= 12 ? "˙" : "&nbsp;") + padToTwoDigitsBase12(hours12 === 0 ? 12 : hours12) + ":" + padToTwoDigitsBase12(minutes) + ":" + padToTwoDigitsBase12(seconds)
            digitalClock24Base12.innerHTML = "&nbsp;" + padToTwoDigitsBase12(hours) + ":" + padToTwoDigitsBase12(minutes) + ":" + padToTwoDigitsBase12(seconds)
            digitalClockBaseFactorial.innerHTML = (hours >= 12 ? "˙" : "&nbsp;") + padToNDigitsBaseFactorial(3, hours12) + ":" + padToNDigitsBaseFactorial(4, minutes) + ":" + padToNDigitsBaseFactorial(4, seconds)
            digitalClock24BaseFactorial.innerHTML = "&nbsp;" + padToNDigitsBaseFactorial(3, hours) + ":" + padToNDigitsBaseFactorial(4, minutes) + ":" + padToNDigitsBaseFactorial(4, seconds)

            analogueClockEmoji.textContent = analogueClockEmojiForHoursAndMinutes(hours12, minutes)

            const zeroIndexedMonth = date.getUTCMonth()
            const dayOfMonth = date.getUTCDate()

            chineseTelegraphMDH.innerHTML = chineseTelegraphSymbolForZeroIndexedMonth(zeroIndexedMonth)
                + chineseTelegraphSymbolForDayOfMonth(dayOfMonth)
                + (hours >= 12 ? "˙" : "&nbsp;") + chineseTelegraphSymbolForHour(hours12)

            chineseTelegraphMDH24.innerHTML = chineseTelegraphSymbolForZeroIndexedMonth(zeroIndexedMonth)
                + chineseTelegraphSymbolForDayOfMonth(dayOfMonth)
                + "&nbsp;" + chineseTelegraphSymbolForHour(hours)

            chineseTelegraphDigitsMDH.textContent = chineseTelegraphDigitsForZeroIndexedMonth(zeroIndexedMonth)
                + " "
                + chineseTelegraphDigitsForDayOfMonth(dayOfMonth)
                + " "
                + chineseTelegraphDigitsForHour(hours)

            const nextHours12 = (hours12 + 1) % 12
            const nextHours24 = (hours + 1) % 24

            const signedFiveMinutesRounded = Math.round((((time % Time.HOUR_IN_MILLIS)/Time.HOUR_IN_MILLIS) * (60 / 5))) * 5

            let fiveMinutesRounded;
            if (signedFiveMinutesRounded > 0) {
                fiveMinutesRounded = signedFiveMinutesRounded
            } else {
                fiveMinutesRounded = 60 + signedFiveMinutesRounded
            }
            // For -0
            fiveMinutesRounded = Math.abs(fiveMinutesRounded)

            const getTimePhrase = (currentHours, nextHours, divisor) => {
                let timePhrase
                switch (fiveMinutesRounded) {
                    default:
                        console.error("Got unexpected value for fiveMinutesRounded: "+ fiveMinutesRounded)
                        timePhrase = "Uh... half past a freckle"
                    break
                    case 0:
                        timePhrase = hoursToWord(currentHours, divisor) + (divisor === 24 ? " hundred" : " o'clock")
                    break
                    case 5:
                        timePhrase = "Five past " + hoursToWord(currentHours, divisor)
                    break
                    case 10:
                        timePhrase = "Ten past " + hoursToWord(currentHours, divisor)
                    break
                    case 15:
                        timePhrase = "Quarter past " + hoursToWord(currentHours, divisor)
                    break
                    case 20:
                        timePhrase = "Twenty past " + hoursToWord(currentHours, divisor)
                    break
                    case 25:
                        timePhrase = "Twenty-Five past " + hoursToWord(currentHours, divisor)
                    break
                    case 30:
                        timePhrase = "Half past " + hoursToWord(currentHours, divisor)
                    break
                    case 35:
                        timePhrase = "Twenty-Five to " + hoursToWord(nextHours, divisor)
                    break
                    case 40:
                        timePhrase = "Twenty to " + hoursToWord(nextHours, divisor)
                    break
                    case 45:
                        timePhrase = "Quarter to " + hoursToWord(nextHours, divisor)
                    break
                    case 50:
                        timePhrase = "Ten to " + hoursToWord(nextHours, divisor)
                    break
                    case 55:
                        timePhrase = "Five to " + hoursToWord(nextHours, divisor)
                    break
                    case 60:
                        timePhrase = hoursToWord(nextHours, divisor) + " o'clock"
                    break
                }

                return timePhrase
            }

            verbalClock.textContent = getTimePhrase(hours12, nextHours12, 12)
            verbalClock24.textContent = getTimePhrase(hours, nextHours24, 24)
            verbalTime.textContent = intToWords(time)
            // This keeps the height at its maximum value so far
            verbalTime.style.minHeight = verbalTime.scrollHeight + "px"

            renderClock({time, ctx: analogueClock12Ctx})
            renderClock({time, ctx: analogueClock24Ctx, numberXYs: twentyFourHourClockNumberXYs, divisor: 24})
            renderClock({time, ctx: analogueClockBase12Ctx, textForIndex: base12TextForIndex})
            renderClock({time, ctx: analogueClock24Base12Ctx, textForIndex: base12TextForIndex, numberXYs: twentyFourHourClockNumberXYs, divisor: 24})
            renderClock({time, ctx: analogueClockBaseFactorialCtx, textForIndex: factorialTextForIndex})
            renderClock({
                time,
                ctx: analogueClock24BaseFactorialCtx,
                textForIndex: factorialTextForIndex,
                numberXYs: twentyFourHourClockNumberXYs,
                divisor: 24,
                rotationForIndex: (i) =>
                    i === 23 || i === 0 || i === 1 || i === 11 || i === 12 || i === 13 ? TAU/4 : 0,
            })
            renderClock({
                time,
                ctx: analogueClockVerbalCtx,
                textForIndex: wordForIndex,
                rotationForIndex: (i) => {
                    switch (i) {
                        case 3:
                            return TAU/4;
                        case 8:
                            return TAU/8;
                        case 11:
                            return -TAU/8;
                        default:
                            return 0;
                    }
                },
            })
            renderClock({
                time,
                ctx: analogueClockVerbal24Ctx,
                textForIndex: wordForIndex,
                numberXYs: twentyFourHourClockVerbalNumberXYs,
                rotationForIndex: (i) => {
                    switch (i) {
                        case 11:
                            return TAU/8;
                        default:
                            return 0;
                    }
                },
                divisor: 24
            })
            renderClock({time, ctx: analogueClock12ZeroOffsetCtx, numberXYs: twelveHourZeroOffsetClockNumberXYs, topOfClockShift: 0})
            renderClock({time, ctx: analogueClockEmojiNumbersCtx, textForIndex: i => analogueClockEmojiForHoursAndMinutes(i == 0 ? 12 : i, 0)})
            renderClock({time, ctx: analogueClockChineseTelegraphCtx, textForIndex: i => chineseTelegraphSymbolForHour(i == 0 ? 12 : i)})
            renderClock({time, ctx: analogueClockChineseTelegraph24Ctx, textForIndex: i => chineseTelegraphSymbolForHour(i == 0 ? 24 : i), numberXYs: twentyFourHourClockNumberXYs, divisor: 24})

            const weekdayNumber = date.getUTCDay()

            let weekdayWord
            switch (weekdayNumber) {
                default:
                    console.error("Unexpected weekdayNumber:" + weekdayNumber)
                    // fallthrough
                case 0:
                    weekdayWord = "Sunday"
                break
                case 1:
                    weekdayWord = "Monday"
                break
                case 2:
                    weekdayWord = "Tuesday"
                break
                case 3:
                    weekdayWord = "Wednesday"
                break
                case 4:
                    weekdayWord = "Thursday"
                break
                case 5:
                    weekdayWord = "Friday"
                break
                case 6:
                    weekdayWord = "Saturday"
                break
            }

            verbalEnglishWeekday.textContent = weekdayWord

            const year = date.getUTCFullYear()
            const isLeap = Time.isGregorianLeapYear(year)

            const startOfYear = Time.getStartOfYear(date)
            const startOfYearWeekdayNumber = startOfYear.getUTCDay()

            const DOMINICAL_LETTER_BY_WEEKDAY_NUMBER = ['A', 'G', 'F', 'E', 'D', 'C', 'B']

            let dominicalLetters = DOMINICAL_LETTER_BY_WEEKDAY_NUMBER[startOfYearWeekdayNumber]
            if (isLeap) {
                const octoberFirst = Time.getGregorianOctoberFirst(date)
                const octoberFirstWeekdayNumber = octoberFirst.getUTCDay()
                dominicalLetters += DOMINICAL_LETTER_BY_WEEKDAY_NUMBER[octoberFirstWeekdayNumber]
            }
            gregorianDominicalLetters.textContent = dominicalLetters

            const weekdayNumberOfFirstDay = startOfYear.getUTCDay();

            // TODO pull these week number calculations into a single,
            // pure, Time function, so we can then paramterize it on
            // calendar type, once we have enough calendars where that
            // would be interesting

            // IIFE for a fresh scope
            (() => {
                const firstDayOfFirstWeekTime = startOfYear.getTime() - (Time.DAY_IN_MILLIS * weekdayNumberOfFirstDay);

                let weekNumberCounter = 0;
                let weekNumberTime = firstDayOfFirstWeekTime;
                while (weekNumberTime <= time) {
                    weekNumberCounter += 1;
                    weekNumberTime += Time.WEEK_IN_MILLIS;
                }

                let yearOfWeek = year;
                if (weekNumberCounter > 52) {
                    weekNumberCounter = 1;
                    yearOfWeek += 1;
                }

                weekNumberFirstSaturday.textContent = "Week " + weekNumberCounter + " of " + yearOfWeek;
                weekCardFirstSaturday.textContent = unicodePlayingCardForNumber(weekNumberCounter) + " of " + yearOfWeek
            })();

            // IIFE for a fresh scope
            (() => {
                const saturdayStartWeekdayNumberOfFirstDay = (weekdayNumberOfFirstDay + 1) % 7;

                const firstDayOfFirstWeekTime = startOfYear.getTime() - (Time.DAY_IN_MILLIS * saturdayStartWeekdayNumberOfFirstDay);

                let weekNumberCounter = 0;
                let weekNumberTime = firstDayOfFirstWeekTime;
                while (weekNumberTime <= time) {
                    weekNumberCounter += 1;
                    weekNumberTime += Time.WEEK_IN_MILLIS;
                }

                let yearOfWeek = year;
                if (weekNumberCounter > 52) {
                    weekNumberCounter = 1;
                    yearOfWeek += 1;
                }

                weekNumberFirstFriday.textContent = "Week " + weekNumberCounter + " of " + yearOfWeek;
                weekCardFirstFriday.textContent = unicodePlayingCardForNumber(weekNumberCounter) + " of " + yearOfWeek
            })();

            // IIFE for a fresh scope
            (() => {
                const mondayStartWeekdayNumberOfFirstDay = sundayStartWeekNumberToMondayStart(weekdayNumberOfFirstDay);

                const firstDayOfFirstWeekTime = startOfYear.getTime() - (Time.DAY_IN_MILLIS * mondayStartWeekdayNumberOfFirstDay);

                let weekNumberCounter = 0;
                let weekNumberTime = firstDayOfFirstWeekTime;
                while (weekNumberTime <= time) {
                    weekNumberCounter += 1;
                    weekNumberTime += Time.WEEK_IN_MILLIS;
                }

                let yearOfWeek = year;
                if (weekNumberCounter > 52) {
                    weekNumberCounter = 1;
                    yearOfWeek += 1;
                }

                weekNumberFirstSunday.textContent = "Week " + weekNumberCounter + " of " + yearOfWeek;
                weekCardFirstSunday.textContent = unicodePlayingCardForNumber(weekNumberCounter) + " of " + yearOfWeek
            })();

            const {iso8601WeekNumber, yearOfISO8601Week} = getISO8601WeekNumber(date);

            weekNumberISO8601.textContent = "Week " + iso8601WeekNumber + " of " + yearOfISO8601Week;
            weekCardISO8601.textContent = unicodePlayingCardForNumber(iso8601WeekNumber) + " of " + yearOfISO8601Week

            const ifcMAndD = Time.ifcZeroIndexedMonthAndDay(date);

            const YEAR_DAY_CARD_NUMBER = 53
            const LEAP_DAY_CARD_NUMBER = 54
            let weekCardNumberIFC
            switch (ifcMAndD.zeroIndexedMonthNumber) {
                case Time.IFC_ZERO_INDEXED_LEAP_MONTH:
                    if (ifcMAndD.dayOfMonth > Time.IFC_NORMAL_DAYS_PER_MONTH) {
                        weekCardNumberIFC = LEAP_DAY_CARD_NUMBER
                        break
                    }
                    // fallthrough
                case 0:
                case 1:
                case 2:
                case 3:
                case 4:
                case 6:
                case 7:
                case 8:
                case 9:
                case 10:
                case 11:
                case 12:
                    weekCardNumberIFC = ifcMAndD.zeroIndexedMonthNumber * 4 + Math.floor((ifcMAndD.dayOfMonth - 1) / 7) + 1;
                break
                default:
                case Time.IFC_ZERO_INDEXED_YEAR_DAY_MONTH:
                    weekCardNumberIFC = YEAR_DAY_CARD_NUMBER
                break

            }

            weekNumberIFC.textContent =
                (weekCardNumberIFC == YEAR_DAY_CARD_NUMBER)
                    ? "Year day"
                    : (weekCardNumberIFC == LEAP_DAY_CARD_NUMBER)
                        ? "Leap day"
                        : "Week " + weekCardNumberIFC + " of " + year;
            weekCardIFC.textContent = unicodePlayingCardForNumber(weekCardNumberIFC) + " of " + year

            const oneIndexedMonth = zeroIndexedMonth + 1

            digitalDate.textContent = `${year}-${padToTwoDigits(oneIndexedMonth)}-${padToTwoDigits(dayOfMonth)}`
            const base = dayOfMonth + 1
            digitalDateBaseDayOfMonthPlusOne.textContent = `${year.toString(base)}-${padStringToTwoDigits(oneIndexedMonth.toString(base))}-${padStringToTwoDigits(dayOfMonth.toString(base))}`

            const ifcOneIndexedMonth = ifcMAndD.zeroIndexedMonthNumber + 1

            const ifcBase = ifcMAndD.dayOfMonth + 1
            digitalIFCDateBaseDayOfMonthPlusOne.textContent = `${year.toString(ifcBase)}-${padStringToTwoDigits((ifcOneIndexedMonth).toString(ifcBase))}-${padStringToTwoDigits(ifcMAndD.dayOfMonth.toString(ifcBase))}`

            digitalDateBaseFactorial.textContent = `${FactorialBase.stringOf(year)}-${padToNDigitsBaseFactorial(3, oneIndexedMonth)}-${padToNDigitsBaseFactorial(5, dayOfMonth)}`
            digitalIFCDateBaseFactorial.textContent = `${FactorialBase.stringOf(year)}-${padToNDigitsBaseFactorial(3, ifcOneIndexedMonth)}-${padToNDigitsBaseFactorial(5, ifcMAndD.dayOfMonth)}`

            let northernMetrologicalSeason
            let southernMetrologicalSeason
            switch(zeroIndexedMonth) {
                default:
                    console.error("unexpected month for metrological seasons: " + zeroIndexedMonth)
                case 0: // Jan
                case 1: // Feb
                case 11: // December
                    northernMetrologicalSeason = "Winter"
                    southernMetrologicalSeason = "Summer"
                break
                case 2:
                case 3:
                case 4:
                    northernMetrologicalSeason = "Spring"
                    southernMetrologicalSeason = "Fall (Autumn)"
                break
                case 5:
                case 6:
                case 7:
                    northernMetrologicalSeason = "Summer"
                    southernMetrologicalSeason = "Winter"
                break
                case 8:
                case 9:
                case 10:
                    northernMetrologicalSeason = "Fall (Autumn)"
                    southernMetrologicalSeason = "Spring"
                break

            }

            metrologicalSeasonsNorth.textContent = northernMetrologicalSeason
            metrologicalSeasonsSouth.textContent = southernMetrologicalSeason

            // TODO align to conjunctions and use that to count and display the number of conjunctions
            synodicMonth.textContent = toAtMost10Chars(time / SYNODIC_MONTH_IN_MILLIS)

            // TODO align to equinoxes and use that to count and display the number of equinoxes
            tropicalMonth.textContent = toAtMost10Chars(time / TROPICAL_MONTH_IN_MILLIS)

            // TODO align to fixed star points and use that to count and display the number of fixed star points
            sideralMonth.textContent = toAtMost10Chars(time / SIDERAL_MONTH_IN_MILLIS)

            // TODO align to perigrees and use that to count and display the number of perigrees
            anomalisticMonth.textContent = toAtMost10Chars(time / ANOMALISTIC_MONTH_IN_MILLIS)

            // TODO align to node events and use that to count and display the number of node events
            dragonicMonth.textContent = toAtMost10Chars(time / DRAGONIC_MONTH_IN_MILLIS)
        }

        const hoursToWord = (n, divisor) => {
            n = n % divisor
            if (n === 0) {
                n = divisor
            }
            return intToWords(n)
        }

        const renderClock = ({time, ctx, divisor, numberXYs, topOfClockShift, textForIndex, rotationForIndex}) => {
            divisor ||= 12
            numberXYs ||= twelveHourClockNumberXYs
            topOfClockShift = topOfClockShift === undefined ? -0.25 : topOfClockShift
            textForIndex ||= clockTextForIndex
            rotationForIndex ||= () => 0;

            const scale = ctx.scale
            ctx = ctx.ctx

            const lengths = clockLengths(scale)

            ctx.clearRect(0, 0, lengths.clockWidth, lengths.clockHeight)

            ctx.fillStyle = "#eee"
            ctx.beginPath();
            ctx.arc(lengths.clockX, lengths.clockY, lengths.clockRadius, 0, 2 * Math.PI)
            ctx.fill();

            ctx.lineWidth = 3;
            ctx.strokeStyle = '#5a7d8b';
            ctx.stroke();

            ctx.fillStyle = "#222"
            ctx.font = (6 * scale) + "px sans-serif";
            const numberXYsArray = numberXYs(scale)
            for (let i = 0; i < numberXYsArray.length; i += 1) {
                const [baseX, baseY] = numberXYsArray[i]

                const text = textForIndex(i, divisor)
                const metrics = ctx.measureText(text)

                const angle = rotationForIndex(i)

                ctx.save();
                ctx.translate(baseX, baseY);
                ctx.rotate(angle);
                ctx.fillText(text, -metrics.width / 2, metrics.fontBoundingBoxDescent);
                ctx.restore();
            }

            const hourDivisor = 24 / divisor

            const hourFrac = (time % (Time.DAY_IN_MILLIS / hourDivisor)) / (Time.DAY_IN_MILLIS / hourDivisor)
            const minuteFrac = (time % Time.HOUR_IN_MILLIS) / Time.HOUR_IN_MILLIS
            const secondFrac = (time % Time.MINUTE_IN_MILLIS) / Time.MINUTE_IN_MILLIS

            ctx.lineWidth = 3;
            ctx.strokeStyle = '#3352e1';
            ctx.beginPath()
            ctx.moveTo(lengths.clockX, lengths.clockY)
            const hourAngle = (hourFrac + topOfClockShift) * TAU
            ctx.lineTo(lengths.clockX + Math.cos(hourAngle) * lengths.clockHourRadius, lengths.clockY + Math.sin(hourAngle) * lengths.clockHourRadius)
            ctx.stroke()

            ctx.lineWidth = 2;
            ctx.strokeStyle = '#5a7d8b';
            ctx.beginPath()
            ctx.moveTo(lengths.clockX, lengths.clockY)
            const minuteAngle = (minuteFrac + topOfClockShift) * TAU
            ctx.lineTo(lengths.clockX + Math.cos(minuteAngle) * lengths.clockMinuteRadius, lengths.clockY + Math.sin(minuteAngle) * lengths.clockMinuteRadius)
            ctx.stroke()

            ctx.lineWidth = 1;
            ctx.strokeStyle = '#de4949';
            ctx.beginPath()
            ctx.moveTo(lengths.clockX, lengths.clockY)
            const secondAngle = (secondFrac + topOfClockShift) * TAU
            ctx.lineTo(lengths.clockX + Math.cos(secondAngle) * lengths.clockSecondRadius, lengths.clockY + Math.sin(secondAngle) * lengths.clockSecondRadius)
            ctx.stroke()
        }

        const intToWords = (n) => {
            let output = ""

            if (n < 0) {
                output += "Minus "
            }

            n = Math.abs(n)

            for (let [roundValue, word] of [
                // This covers up to Number.MAX_SAFE_INTEGER, which seems as good a place to stop as any
                [1_000_000_000_000_000_000, "Quintillion"],
                [1_000_000_000_000_000, "Quadrillion"],
                [1_000_000_000_000, "Trillion"],
                [1_000_000_000, "Billion"],
                [1_000_000, "Million"],
                [1000, "Thousand"],
                [100, "Hundred"]
            ]) {
                if (n === roundValue) {
                    output += intToWords(1) + " " + word
                    return output
                } else if (n > roundValue) {
                    const leadingDigits = Math.floor(n / roundValue)
                    output += intToWords(leadingDigits) + " " + word + " "
                    n -= leadingDigits * roundValue
                    if (n === 0) {
                        return output
                    }
                }
            }

            for (let [multipleOfTen, word] of [[90, "Ninety"], [80, "Eighty"], [70, "Seventy"], [60, "Sixty"], [50, "Fifty"], [40, "Forty"], [30, "Thirty"], [20, "Twenty"]]) {
                if (n === multipleOfTen) {
                    output += word
                    return output
                } else if (n > multipleOfTen) {
                    output += intToWords(multipleOfTen) + '-' + intToWords(n % multipleOfTen)
                    return output
                }
            }
            switch (n) {
                default:
                    console.error("Unhandled case in intToWords: " + n)
                    return "" + n
                case 0:
                    output += "Zero"
                break
                case 1:
                    output += "One"
                break
                case 2:
                    output += "Two"
                break
                case 3:
                    output += "Three"
                break
                case 4:
                    output += "Four"
                break
                case 5:
                    output += "Five"
                break
                case 6:
                    output += "Six"
                break
                case 7:
                    output += "Seven"
                break
                case 8:
                    output += "Eight"
                break
                case 9:
                    output += "Nine"
                break
                case 10:
                    output += "Ten"
                break
                case 11:
                    output += "Eleven"
                break
                case 12:
                    output += "Twelve"
                break
                case 13:
                    output += "Thirteen"
                break
                case 14:
                    output += "Fourteen"
                break
                case 15:
                    output += "Fifteen"
                break
                case 16:
                    output += "Sixteen"
                break
                case 17:
                    output +="Seventeen"
                break
                case 18:
                    output += "Eighteen"
                break
                case 19:
                    output += "Nineteen"
                break
            }

            return output
        }

        const padToTwoDigits = (n) => {
            return (n < 10 ? "0" : "") + n
        }

        const padToTwoDigitsBase12 = (n) => {
            return (n < 12 ? "0" : lastBase12Digit(n/12)) + lastBase12Digit(n)
        }

        const padToNDigitsBaseFactorial = (digits, toPad) => {
            let output = FactorialBase.stringOf(toPad)

            while (output.length < digits) {
                output = "0" + output
            }

            return output
        }

        const padStringToTwoDigits = (s) => {
            return (s.length === 0 ? "00" : (s.length === 1 ? "0" : "")) + s
        }

        const PLAYING_CARD_CHARS = [
            "🂡", "🂢", "🂣", "🂤", "🂥", "🂦", "🂧", "🂨", "🂩", "🂪", "🂫", "🂭", "🂮",
            "🂱", "🂲", "🂳", "🂴", "🂵", "🂶", "🂷", "🂸", "🂹", "🂺", "🂻", "🂽", "🂾",
            "🃁", "🃂", "🃃", "🃄", "🃅", "🃆", "🃇", "🃈", "🃉", "🃊", "🃋", "🃍", "🃎",
            "🃑", "🃒", "🃓", "🃔", "🃕", "🃖", "🃗", "🃘", "🃙", "🃚", "🃛", "🃝", "🃞",
            "🃏", "🂠"
        ]

        const JOKER_INDEX = 52

        const unicodePlayingCardForNumber = (n) => {
            return PLAYING_CARD_CHARS[n - 1] || PLAYING_CARD_CHARS[JOKER_INDEX]
        }

        const ANALOGUE_CLOCK_CHARS = [
            "🕛",
            "🕧",
            "🕐",
            "🕜",
            "🕑",
            "🕝",
            "🕒",
            "🕞",
            "🕓",
            "🕟",
            "🕔",
            "🕠",
            "🕕",
            "🕡",
            "🕖",
            "🕢",
            "🕗",
            "🕣",
            "🕘",
            "🕤",
            "🕙",
            "🕥",
            "🕚",
            "🕦",
        ]

        const analogueClockEmojiForHoursAndMinutes = (hours, minutes) => {
            let thirty
            if (minutes < 15) {
                thirty = 0
            } else if (minutes >= 15 && minutes < 45) {
                thirty = 1
            } else {
                hours += 1
                thirty = 0
            }
            hours %= 12

            return ANALOGUE_CLOCK_CHARS[(hours * 2) + thirty]
        }

        const CHINESE_TELEGRAPH_MONTH_CHARS = [
            "㋀",
            "㋁",
            "㋂",
            "㋃",
            "㋄",
            "㋅",
            "㋆",
            "㋇",
            "㋈",
            "㋉",
            "㋊",
            "㋋"
        ]

        const chineseTelegraphSymbolForZeroIndexedMonth = (month) => {
            return CHINESE_TELEGRAPH_MONTH_CHARS[month]
        }

        const chineseTelegraphDigitsForZeroIndexedMonth = (month) => {
            return 9701 + month
        }

        const CHINESE_TELEGRAPH_DAY_CHARS = [
            "㏠",
            "㏡",
            "㏢",
            "㏣",
            "㏤",
            "㏥",
            "㏦",
            "㏧",
            "㏨",
            "㏩",
            "㏪",
            "㏫",
            "㏬",
            "㏭",
            "㏮",
            "㏯",
            "㏰",
            "㏱",
            "㏲",
            "㏳",
            "㏴",
            "㏵",
            "㏶",
            "㏷",
            "㏸",
            "㏹",
            "㏺",
            "㏻",
            "㏼",
            "㏽",
            "㏾"
        ]

        const chineseTelegraphSymbolForDayOfMonth = (dayOfMonth) => {
            return CHINESE_TELEGRAPH_DAY_CHARS[dayOfMonth - 1]
        }

        const chineseTelegraphDigitsForDayOfMonth = (dayOfMonth) => {
            return 9900 + dayOfMonth
        }

        const CHINESE_TELEGRAPH_HOUR_CHARS = [
            "㍘",
            "㍙",
            "㍚",
            "㍛",
            "㍜",
            "㍝",
            "㍞",
            "㍟",
            "㍠",
            "㍡",
            "㍢",
            "㍣",
            "㍤",
            "㍥",
            "㍦",
            "㍧",
            "㍨",
            "㍩",
            "㍪",
            "㍫",
            "㍬",
            "㍭",
            "㍮",
            "㍯",
            "㍰",
        ]

        const chineseTelegraphSymbolForHour = (hour) => {
            return CHINESE_TELEGRAPH_HOUR_CHARS[hour]
        }

        const chineseTelegraphDigitsForHour = (hour) => {
            return 9800 + hour
        }

        const playPause = document.getElementById("play-pause");
        playPause.onclick = () => {
            switch (inputMode) {
                case RUNNING:
                    inputMode = PAUSED
                break
                case PAUSED:
                    inputMode = RUNNING
                    renderStep()
                break
            }
        };

        const applyCalendarSpecs = (
            {
                monthLabel,
                weekLabels,
                boxes,
                extraBoxesLabel,
                extraBoxes,
            },
            {
                monthText,
                boxSpecs,
                appearance,
            }
        ) => {
            monthLabel.innerHTML = monthText

            if (appearance === Time.HIDE_WEEK_ROW) {
                weekLabels.style.display = "none"
            }

            let len = boxSpecs.length
            if (appearance === Time.LAST_DAY_OUTSIDE_WEEK) {
                len -= 1
            }

            let newBoxes = ''
            for (let i = 0; i < len; i += 1) {
                newBoxes += boxHtml(boxSpecs[i])
            }
            boxes.innerHTML = newBoxes

            if (appearance === Time.LAST_DAY_OUTSIDE_WEEK) {
                extraBoxesLabel.style.display = "block"
                extraBoxesLabel.textContent = "No Week Day"
                extraBoxes.style.display = "block"
                extraBoxes.innerHTML = boxHtml(boxSpecs[boxSpecs.length - 1])
            } else {
                extraBoxesLabel.style.display = "none"
                extraBoxes.style.display = "none"
            }
        }

        const boxHtml = (
            {text, kind, linkedTime}
        ) => {
            let className;
                switch (kind) {
                    default:
                        console.error("No classname for spec kind: " + kind)
                        // fallthrough
                    case Time.OTHER_MONTH:
                        className = "other-month"
                    break
                    case Time.CURRENT_MONTH:
                        className = "current-month"
                    break
                    case Time.CURRENT_DAY:
                        className = "current-day"
                    break
                }

            return `<div class="${className}" onclick="setFromTimeAndRender(${linkedTime})">
                ${text}
            </div>`
        }


        const renderStep = () => {
            renderAt(new Date())

            switch (inputMode) {
                case RUNNING:
                    requestAnimationFrame(renderStep)
                break
                case PAUSED:
                    // don't do another frame
                break
            }

        }
        renderStep()

        // TODO show the equivalent of the Dominical letters for the given year based on the IFC
        //   So one of two types of letters, indicating whether it is a leap year or not
        // TODO Is there a calendar that fits with the tarot deck including the major arcana? If not, invent one.
        //   78 cards total, 22 major arcana, 56 minor arcana of 4 suits of 14 cards each
        //       A positive diophatine solver reveals that 3*56 + 9*22 = 366, but no solutions for a*56 + b*22 = 365 exist
        //           So a repeating pattern of minor arcana, waxing major arcana, full major arcana, waning major arcana, and back around to minor arcana?
        //   One way to invent it would be to make weeks different lengths until all the days are accounted for
        //   Fool's day should be April 1st, or maybe Feb 29th?
        // TODO show a gregorian calendar using a subset of the years that covers the possible years
        //   Maybe show 14 whole year calendars and show a dot jumping from day to day
        // TODO? The different types of whole year calendar thing but for the IFC? Or is that too boring?
        // TODO? show a 12 and 24 hour analogue clock with chinese telegraph digits? Or is that too boring? Also, a 12 hour verbal version
        // TODO show a continued Julian calendar
        // TODO show the Dominical letters for the given Julian year (https://en.wikipedia.org/wiki/Dominical_letter)
        // TODO show the day of the Pawukon as described in the article mentioned below. Apparently a particular date in the Julian calendar is a traditional base.
        //    https://en.wikipedia.org/wiki/Pawukon_calendar
        // TODO show French Republican decimal time
        // TODO show French Republican Calendar
        // TODO show Swatch Internet time
        // TODO show a version of the clock on xkcd.com/now
        // TODO show a "digital analogue" clock that merely prints the angle of the hands
        //  I guess a analogue digital clock would be one of those ones where the digits are shown on cards that flip over?
        // TODO add a analogue clock that has second, minute, hour, day, and week hands
        // TODO add a analogue clock that has a minute hand, a millenium hand, and an eon hand.
        //   Can probably call an eon the average length of a geologic eon, or since wikipedia says "half a billion years or more", just use a nice round number close to half a billion years
        // TODO? invent and show an "analogue date"?
        //     I guess numbers for the months? Maybe this would only make sense for a calandar with truly fixed length months? What if a "year" is 4 years to bake in leap year stuff?
        // TODO show phases of the moon with symbols, as seen in northern and southern hemispheres (This is apparently hard to do accurately!)
        // TODO show position in the Sexagenary cycle/ganzhi
        //    Doing this properly depends on the lunar new year, which in turn depends on the phases of the moon
        //    Any other similar cycles like this? Mayan calendar maybe?
        // TODO? show if the current day or other time period is mildy interesting in a different calendar than usual?
        //    For example, IFC April fool's day, King of hearts week
        //    But is there enough of these to be worth it? There are more of these if there's more calendars
        // TODO? Find a random generator of something, say names, and define a total order to its output and thus map the output to some appropriate time period with a repeating cycle, e.g. name of the day or hour

        // TODO? add labels to more of the timepieces, maybe making them optional?

        // TODO? Make the creation of the HTML elements based on some JS constants, making the defintions less spread out?
        // TODO? Abstract over having both 12 and 24 hour versions of clocks?

        // TODO Consider adding more controllable categories
    </script>
</body>
</html>
