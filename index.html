<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Time</title><style type="text/css">body{
margin:40px auto;
max-width:650px;
line-height:1.6;
font-size:18px;
color:#eee;
background-color:#111;
padding:0 10px
}
textarea, input, button {
color:#eee;
background-color:#111;
}
.button-container {
  padding: 0;
  margin: 0;
  display: flex;
  justify-content: space-between;
}
.seven-columns {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
  width: 100%;
  text-align: center;
}
.other-month {
  color: #888;
}
.current-month {}
.current-day {
    border: solid 0.125ex;
}
</style>
</head>

<body>
    <div>
        <div class="button-container">
            <button type="button" id="minus">−</button>
            <button type="button" id="play-pause">&#x23EF;</button>
            <button type="button" id="plus">+</button>
        </div>
        <input id="selected-time" type="range" style="width: 100%;" />
        <output id="displayed-step"></output>
        <div style="display: grid;">
            <output id="raw"></output>
            <output id="utc-string"></output>
            <div style="border: solid 0.125ex;">
                <h4> Gregorian </h4>
                <div class="seven-columns" style="border-bottom: solid 0.125ex;">
                    <div> Sun </div>
                    <div> Mon </div>
                    <div> Tue </div>
                    <div> Wed </div>
                    <div> Thu </div>
                    <div> Fri </div>
                    <div> Sat </div>
                </div>
                <div id="gregorian-calendar-boxes" class="seven-columns">
                </div>
            </div>

            <div style="border: solid 0.125ex;">
                <h4> International Fixed</h4>
                <div class="seven-columns" style="border-bottom: solid 0.125ex;">
                    <div> Sun </div>
                    <div> Mon </div>
                    <div> Tue </div>
                    <div> Wed </div>
                    <div> Thu </div>
                    <div> Fri </div>
                    <div> Sat </div>
                </div>
                <div id="international-fixed-calendar-boxes" class="seven-columns">
                </div>
            </div>
        </div>
    </div>
    <script>
        const DEBUG_MODE = location.protocol === "file:"
        if (DEBUG_MODE) {
            console.log("DEBUG_MODE = " + DEBUG_MODE)
        }

        const displayedStep = document.getElementById("displayed-step");
        const raw = document.getElementById("raw");
        const utcString = document.getElementById("utc-string");
        const input = document.getElementById("selected-time");

        const startTime = new Date().getTime()
        const TIME_ROUND_TO = 1_000_000_000_000

        const defaultLowEdge = Math.floor(startTime / TIME_ROUND_TO) * TIME_ROUND_TO
        const defaultHighEdge = Math.ceil(startTime / TIME_ROUND_TO) * TIME_ROUND_TO

        input.min = defaultLowEdge
        input.max = defaultHighEdge
        const setStep = (step) => {
            input.step = step
            if (step === 1) {
                displayedStep.textContent = ''
            } else {
                displayedStep.textContent = "movement ×" + step.toLocaleString()
            }
        }
        const setFromTime = (time) => {
            input.value = time
        }
        setFromTime(startTime)

        const RUNNING = "running"
        const PAUSED = "paused"

        let inputMode = RUNNING
        input.oninput = () => {
            inputMode = PAUSED
        }

        let moveListener;
        let startClientY;
        input.addEventListener("pointerdown", (e) => {
            startClientY = e.clientY

            l = input.addEventListener("pointermove", (e) => {
              const yDelta = Math.abs(startClientY - e.clientY)

              const PIXELS_PER_STEP = 16;
              // 0 => 1
              // 10 => 10
              // 20 => 100
              // And so on
              const rawStep = Math.pow(10, Math.floor(yDelta/PIXELS_PER_STEP))

              const range = parseInt(input.max) - parseInt(input.min)

              setStep(Math.min(rawStep, range))
            });
        });
        input.addEventListener("pointerup", (e) => {
            input.removeEventListener("pointermove", moveListener)

            // Avoid jittering the input when releasing
            const selectedValue = input.value
            setTimeout(() => setFromTime(selectedValue), 8)
        });

        const minus = document.getElementById("minus");
        minus.onclick = () => {
            input.min = parseInt(input.min) - TIME_ROUND_TO
        };

        const plus = document.getElementById("plus");
        plus.onclick = () => {
            input.max = parseInt(input.max) + TIME_ROUND_TO
        };

        const PREVIOUS = -1
        const CURRENT = 0
        const NEXT = 1

        const gregorianCalendarBoxes = document.getElementById("gregorian-calendar-boxes");
        const internationalFixedCalendarBoxes = document.getElementById("international-fixed-calendar-boxes");

        const calculateCalendarSpecs = (boundsProvider) => {
            const {
                dateOfMonth,
                lastDateOfPreviousMonth,
                dayOfWeekOfLastOfPrevious,
                lastDateOfCurrentMonth,
                dayOfWeekOfFirstOfCurrent,
                dayOfWeekOfFirstOfNext,
                maxBoxesPerPage,
            } = boundsProvider.pageBounds()

            let calendarBoxSpecs = new Array(maxBoxesPerPage)
            let boxIndex = 0;

            const firstVisibleDateOfPreviousMonth = lastDateOfPreviousMonth - dayOfWeekOfLastOfPrevious

            const OTHER_MONTH_CLASS = "other-month"

            for (let i = 0; i < dayOfWeekOfFirstOfCurrent; i += 1) {
                const dayOfMonth = firstVisibleDateOfPreviousMonth + i
                calendarBoxSpecs[boxIndex] = {
                    text: dayOfMonth,
                    className: OTHER_MONTH_CLASS,
                    linkedTime: boundsProvider.linkedTimeFromDayOfMonth(PREVIOUS, dayOfMonth)
                }
                boxIndex += 1
            }

            for (let i = 1; i <= lastDateOfCurrentMonth; i += 1) {
                let className
                if (i === dateOfMonth) {
                    className = "current-day"
                } else {
                    className = "current-month"
                }

                calendarBoxSpecs[boxIndex] = {
                    text: i,
                    className,
                    linkedTime: boundsProvider.linkedTimeFromDayOfMonth(CURRENT, i)
                }

                boxIndex += 1
            }

            let nextMonthDate = 1
            const DAYS_IN_WEEK = 7
            for (
                let i = dayOfWeekOfFirstOfNext;
                i < DAYS_IN_WEEK && boxIndex < calendarBoxSpecs.length;
                i += 1
            ) {
                calendarBoxSpecs[boxIndex] = {
                    text: nextMonthDate,
                    className: OTHER_MONTH_CLASS,
                    linkedTime: boundsProvider.linkedTimeFromDayOfMonth(NEXT, i)
                }

                nextMonthDate += 1
                boxIndex += 1
            }

            return calendarBoxSpecs.flat()
        }

        const setFromTimeAndRender = (time) => {
            inputMode = PAUSED
            setFromTime(time)
            renderAt(new Date(time))
        }

        const applyCalendarSpecs = (parent, specs) => {
            let newBoxes = ''
            for (let i = 0; i < specs.length; i += 1) {
                const {text, className, linkedTime} = specs[i]
                newBoxes += `<div class="${className}" onclick="setFromTimeAndRender(${linkedTime})">
                    ${text}
                </div>`
            }
            parent.innerHTML = newBoxes
        }

        const renderAt = (date) => {
            const time = date.getTime()
            setFromTime(input.value)
            raw.textContent = time.toLocaleString()
            utcString.textContent = date.toUTCString()

            const gregorianBoundsProvider = {
                date,
                pageBounds() {
                    const date = this.date

                    const year = date.getUTCFullYear()
                    const month = date.getUTCMonth()
                    const dateOfMonth = date.getUTCDate()

                    const lastOfPreviousMonth = new Date(year, month, 0)

                    const lastDateOfPreviousMonth = lastOfPreviousMonth.getUTCDate()
                    const dayOfWeekOfLastOfPrevious = lastOfPreviousMonth.getUTCDay()
                    const lastDateOfCurrentMonth = new Date(year, month + 1, 0).getUTCDate()
                    const dayOfWeekOfFirstOfCurrent = new Date(year, month, 1).getUTCDay()
                    const dayOfWeekOfFirstOfNext = new Date(year, month + 1, 1).getUTCDay()

                    return {
                        dateOfMonth,
                        lastDateOfPreviousMonth,
                        dayOfWeekOfLastOfPrevious,
                        lastDateOfCurrentMonth,
                        dayOfWeekOfFirstOfCurrent,
                        dayOfWeekOfFirstOfNext,
                        maxBoxesPerPage: 42
                    };
                },
                linkedTimeFromDayOfMonth(monthDelta, dayOfMonth) {
                    const year = date.getUTCFullYear()
                    const month = date.getUTCMonth() + monthDelta
                    return new Date(year, month, dayOfMonth).getTime()
                }
            }

            const gregorianCalendarBoxSpecs = calculateCalendarSpecs(gregorianBoundsProvider)

            applyCalendarSpecs(gregorianCalendarBoxes, gregorianCalendarBoxSpecs)

            if (DEBUG_MODE) {
                const internationalFixedBoundsProvider = {
                    date,
                    pageBounds() {
                        const date = this.date

                        const year = date.getUTCFullYear()
                        const month = date.getUTCMonth()
                        // TODO Calculate this properly for this calendar
                        const dateOfMonth = date.getUTCDate()

                        const lastDateOfPreviousMonth = 28
                        const dayOfWeekOfLastOfPrevious = 6
                        const lastDateOfCurrentMonth = 28
                        const dayOfWeekOfFirstOfCurrent = 0
                        const dayOfWeekOfFirstOfNext = 0

                        return {
                            dateOfMonth,
                            lastDateOfPreviousMonth,
                            dayOfWeekOfLastOfPrevious,
                            lastDateOfCurrentMonth,
                            dayOfWeekOfFirstOfCurrent,
                            dayOfWeekOfFirstOfNext,
                            maxBoxesPerPage: 28
                        };
                    },
                    linkedTimeFromDayOfMonth(monthDelta, dayOfMonth) {
                        const year = date.getUTCFullYear()
                        const month = date.getUTCMonth() + monthDelta
                        return new Date(year, month, dayOfMonth).getTime()
                    }
                }

                const internationalFixedCalendarBoxSpecs = calculateCalendarSpecs(internationalFixedBoundsProvider)

                applyCalendarSpecs(internationalFixedCalendarBoxes, internationalFixedCalendarBoxSpecs)
            } else {
                internationalFixedCalendarBoxes.parentElement.style.display = "none"
            }

        }

        input.addEventListener("input", (event) => {
            // TODO? Are we gonna want to debounce this?
            const v = event.target.value
            renderAt(new Date(parseInt(v)))
        });

        const playPause = document.getElementById("play-pause");
        playPause.onclick = () => {
            switch (inputMode) {
                case RUNNING:
                    inputMode = PAUSED
                break
                case PAUSED:
                    inputMode = RUNNING
                    renderStep()
                break
            }
        };

        const renderStep = () => {
            renderAt(new Date())

            switch (inputMode) {
                case RUNNING:
                    requestAnimationFrame(renderStep)
                break
                case PAUSED:
                    // don't do another frame
                break
            }

        }
        renderStep()

        // TODO show a digital clock.
        // TODO show an analog clock.
        // TODO look up that 13 * 28 + 1 calendar and display that
        // TODO show a base 12 digital clock
        // TODO show a base 12 analog clock
        // TODO show the date in the base of the current day of the month, by the common calendar
        // TODO show the date in the base of the current day of the month, by the 13 * 28 + 1 calendar
    </script>
</body>
</html>
