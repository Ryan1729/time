<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Time</title><style type="text/css">body{
margin:40px auto;
max-width:650px;
line-height:1.6;
font-size:18px;
color:#eee;
background-color:#111;
padding:0 10px
}
textarea, input, button {
color:#eee;
background-color:#111;
}
:root {
  --thin-border: solid 0.125ex;
}
.button-container {
  padding: 0;
  margin: 0;
  display: flex;
  justify-content: space-between;
}
.seven-columns {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
  width: 100%;
  text-align: center;
}
.other-month {
  color: #888;
}
.current-month {}
.current-day {
    border: var(--thin-border);
}
.thin-border {
    border: var(--thin-border);
}
.thin-border-row {
    border-top: var(--thin-border);
    border-bottom: var(--thin-border);
}
.month-label {
    text-align: center;
    font-size: 21px;
    font-weight: 700;
}
.center-text {
    text-align: center
}
.calendar-type-label {
    text-align: right;
    font-size: 12px;
    font-weight: 700;
    margin-right: 0.5rem;
    /* Move up into the space of the month label */
    margin-top: -2ex;
}
.digital {
    color: #5a7d8b;
    font-size: 60px;
    font-family: monospace;
    letter-spacing: 7px;
}
.digital-small {
    color: #5a7d8b;
    font-size: 48px;
    font-family: monospace;
    letter-spacing: 7px;
}
.verbal {
    color: #5a7d8b;
    font-size: 48px; /* Small enough to fit "Twenty-Five past Eleven" on one line */
    font-family: cursive;
    letter-spacing: 7px;
}
.clock-row {
    display: inline-flex;
    margin-bottom: 1ex;
}
.labelled-row {
    margin-bottom: 1ex;
}
.labelled-row-label {
    color: #5a7d8b;
    text-align: right;
    font-size: 12px;
    font-weight: 700;
    margin-right: 0.5rem;
    /* Move up into the space of the season text */
    margin-top: -6ex;
    margin-bottom: 0;
}
</style>
</head>

<body>
    <div>
        <div class="button-container">
            <button type="button" id="minus">âˆ’</button>
            <button type="button" id="play-pause">&#x23EF;</button>
            <button type="button" id="plus">+</button>
        </div>
        <input id="selected-time" type="range" style="width: 100%;" />
        <input id="selected-time-number" type="number" />
        <output id="displayed-step"></output>
        <details>
            <summary>
                Subset Controls
            </summary>
            <div style="display: grid;">
                <input id="subset-number" type="number" />
                <span>
                    <button id="subset-shift-up"> &lt;&lt; </button>
                    <button id="subset-shift-down"> &gt;&gt;&gt; </button>
                </span>
            </div>
        </details>
        <div style="display: grid;">
            <output id="raw"></output>
            <output id="utc-string"></output>
            <div class="clock-row">
                <output class="digital" id="digital-clock-12"></output>
                <canvas width=0 height=0 id="analogue-clock-12">
                    A standard analogue clock.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-24"></output>
                <canvas width=0 height=0 id="analogue-clock-24">
                    A 24-hour analogue clock.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-base-12"></output>
                <canvas width=0 height=0 id="analogue-clock-base-12">
                    A standard analogue clock with X, E, and 10 instead of 10, 11 and 12 respevtively.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-24-base-12"></output>
                <canvas width=0 height=0 id="analogue-clock-24-base-12">
                    A 24-hour analogue clock with X, E, and 10 instead of 10, 11 and 12 respevtively, and so on up to 23 being 1E, and 24 being 20.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-base-factorial"></output>
                <canvas width=0 height=0 id="analogue-clock-base-factorial">
                    A standard analogue clock that uses the factorial number system (sans trailing 0) to represent the numbers from 1 to 12
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-clock-24-base-factorial"></output>
                <canvas width=0 height=0 id="analogue-clock-24-base-factorial">
                    A 24-hour analogue clock that uses the factorial number system (sans trailing 0) to represent the numbers from 1 to 24
                </canvas>
            </div>
            <div class="clock-row">
                <output class="verbal" id="verbal-clock"></output>
            </div>
            <div class="clock-row">
                <output class="verbal" id="verbal-time"></output>
            </div>
            <div class="clock-row">
                <canvas width=0 height=0 id="analogue-clock-12-0-offset">
                    A standard analogue clock but rotated so that the 12 is on the far right.
                </canvas>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-date"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-date-base-day-of-month-plus-one"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-ifc-date-base-day-of-month-plus-one"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-date-base-factorial"></output>
            </div>
            <div class="clock-row">
                <output class="digital" id="digital-ifc-date-base-factorial"></output>
            </div>
            <div id="metrological-seasons-north-row" class="labelled-row">
                <output class="verbal" id="metrological-seasons-north"></output>
                <div class="labelled-row-label" > (metrological; northern hemisphere) </div>
            </div>
            <div id="metrological-seasons-south-row" class="labelled-row">
                <output class="verbal" id="metrological-seasons-south"></output>
                <div class="labelled-row-label" > (metrological; southern hemisphere) </div>
            </div>
            <div id="synodic-month-row" class="labelled-row">
                <output class="digital-small" id="synodic-month"></output>
                <div class="labelled-row-label"> Synodic Months relative to the Epoch </div>
            </div>
            <div id="tropical-month-row" class="labelled-row">
                <output class="digital-small" id="tropical-month"></output>
                <div class="labelled-row-label"> Tropical Months relative to the Epoch </div>
            </div>
            <div id="sideral-month-row" class="labelled-row">
                <output class="digital-small" id="sideral-month"></output>
                <div class="labelled-row-label"> Sideral Months relative to the Epoch </div>
            </div>
            <div id="anomalistic-month-row" class="labelled-row">
                <output class="digital-small" id="anomalistic-month"></output>
                <div class="labelled-row-label"> Anomalistic Months relative to the Epoch </div>
            </div>
            <div id="dragonic-month-row" class="labelled-row">
                <output class="digital-small" id="dragonic-month"></output>
                <div class="labelled-row-label"> Dragonic Months relative to the Epoch </div>
            </div>
            <div id="gregorian-calendar" class="thin-border">
                <div id="gregorian-calendar-month" class="month-label"> January </div>
                <div class="calendar-type-label" > Gregorian </div>
                <div id="gregorian-calendar-week-labels" class="seven-columns thin-border-row">
                    <div> Sun </div>
                    <div> Mon </div>
                    <div> Tue </div>
                    <div> Wed </div>
                    <div> Thu </div>
                    <div> Fri </div>
                    <div> Sat </div>
                </div>
                <div id="gregorian-calendar-boxes" class="seven-columns">
                </div>
                <div id="gregorian-calendar-extra-label" class="thin-border-row center-text" style="display: none">
                </div>
                <div id="gregorian-calendar-extra-boxes" class="seven-columns" style="display: none">
                </div>
            </div>
            <div id="international-fixed-calendar", class="thin-border">
                <div id="international-fixed-calendar-month" class="month-label"> January </div>
                <div class="calendar-type-label"> International Fixed</div>
                <div id="international-fixed-calendar-week-labels" class="seven-columns thin-border-row">
                    <div> Sun </div>
                    <div> Mon </div>
                    <div> Tue </div>
                    <div> Wed </div>
                    <div> Thu </div>
                    <div> Fri </div>
                    <div> Sat </div>
                </div>
                <div id="international-fixed-calendar-boxes" class="seven-columns">
                </div>
                <div id="international-fixed-calendar-extra-label" class="thin-border-row center-text" style="display: none">
                </div>
                <div id="international-fixed-calendar-extra-boxes" class="seven-columns" style="display: none">
                </div>
            </div>
        </div>
    </div>
    <script src="factorialBase.js"></script>
    <script src="time.js"></script>
    <script>
        const DEBUG_MODE = location.protocol === "file:"
        if (DEBUG_MODE) {
            console.log("DEBUG_MODE = " + DEBUG_MODE)
        }

        const displayedStep = document.getElementById("displayed-step");
        const raw = document.getElementById("raw");
        const utcString = document.getElementById("utc-string");
        const inputRange = document.getElementById("selected-time");
        const inputNumber = document.getElementById("selected-time-number");

        const subsetNumber = document.getElementById("subset-number");

        const TIMEPIECE_IDS = [
            "digital-clock-12",
            "analogue-clock-12",
            "digital-clock-24",
            "analogue-clock-24",
            "digital-clock-base-12",
            "analogue-clock-base-12",
            "digital-clock-24-base-12",
            "analogue-clock-24-base-12",
            "digital-clock-base-factorial",
            "analogue-clock-base-factorial",
            "digital-clock-24-base-factorial",
            "analogue-clock-24-base-factorial",
            "verbal-clock",
            "verbal-time",
            "analogue-clock-12-0-offset",
            "digital-date",
            "digital-date-base-day-of-month-plus-one",
            "digital-ifc-date-base-day-of-month-plus-one",
            "digital-date-base-factorial",
            "digital-ifc-date-base-factorial",
            "metrological-seasons-north-row",
            "metrological-seasons-south-row",
            "synodic-month-row",
            "tropical-month-row",
            "sideral-month-row",
            "anomalistic-month-row",
            "dragonic-month-row",
            "gregorian-calendar",
            "international-fixed-calendar",
        ]

        const ALL_TIMEPIECES_SUBSET = (1 << TIMEPIECE_IDS.length) - 1
        subsetNumber.value = ALL_TIMEPIECES_SUBSET

        const setSubsetMask = (mask) => {
            subsetNumber.value = mask

            for (let i = 0; i < TIMEPIECE_IDS.length; i += 1) {
                const element = document.getElementById(TIMEPIECE_IDS[i])
                if ((mask & (1 << i)) !== 0) {
                    element.style.display = "unset";
                } else {
                    element.style.display = "none";
                }
            }
        }

        const getCurrentSubsetMask = () => {
            const parsed = parseInt(subsetNumber.value)

            let subset
            if (Number.isNaN(parsed)) {
                subset = ALL_TIMEPIECES_SUBSET
            } else {
                subset = parsed
            }

            return subset
        }

        const onSubsetChange = () => {
            setSubsetMask(getCurrentSubsetMask())
        }
        subsetNumber.oninput = onSubsetChange

        const subsetShiftUp = document.getElementById("subset-shift-up");
        const onShiftUp = () => {
            setSubsetMask(getCurrentSubsetMask() << 1)
        }
        subsetShiftUp.onclick = onShiftUp

        const subsetShiftDown = document.getElementById("subset-shift-down");
        const onShiftDown = () => {
            setSubsetMask(getCurrentSubsetMask() >>> 1)
        }
        subsetShiftDown.onclick = onShiftDown



        const startTime = new Date().getTime()
        const TIME_ROUND_TO = 1_000_000_000_000

        const defaultLowEdge = Math.floor(startTime / TIME_ROUND_TO) * TIME_ROUND_TO
        const defaultHighEdge = Math.ceil(startTime / TIME_ROUND_TO) * TIME_ROUND_TO

        inputRange.min = inputNumber.min = defaultLowEdge
        inputRange.max = inputNumber.max = defaultHighEdge
        const setStep = (step) => {
            inputRange.step = inputNumber.step = step
            if (step === 1) {
                displayedStep.textContent = ''
            } else {
                displayedStep.textContent = "movement Ã—" + step.toLocaleString()
            }
        }
        const setFromTime = (time) => {
            inputRange.value = inputNumber.value = time
        }
        setFromTime(startTime)

        const RUNNING = "running"
        const PAUSED = "paused"

        let inputMode = RUNNING
        const onInput = () => {
            inputMode = PAUSED
            // TODO? Are we gonna want to debounce this?
            const v = event.target.value
            const parsed = parseInt(v)

            const min = parseInt(inputRange.min)
            const max = parseInt(inputRange.max)

            let time
            if (Number.isNaN(parsed) || parsed < min) {
                time = min
            } else if (parsed > max) {
                time = max
            } else {
                time = parsed
            }

            renderAt(new Date(time))
        }
        inputRange.oninput = inputNumber.oninput = onInput

        let moveListener;
        let startClientY;
        inputRange.addEventListener("pointerdown", (e) => {
            startClientY = e.clientY

            l = inputRange.addEventListener("pointermove", (e) => {
              const yDelta = Math.abs(startClientY - e.clientY)

              const PIXELS_PER_STEP = 16;
              const rawStep = Math.pow(10, Math.floor(yDelta/PIXELS_PER_STEP))

              const range = parseInt(inputRange.max) - parseInt(inputRange.min)

              setStep(Math.min(rawStep, range))
            });
        });
        inputRange.addEventListener("pointerup", (e) => {
            inputRange.removeEventListener("pointermove", moveListener)

            // Avoid jittering the input when releasing
            const selectedValue = inputRange.value
            setTimeout(() => setFromTime(selectedValue), 8)
        });

        const minus = document.getElementById("minus");
        minus.onclick = () => {
            inputRange.min = inputNumber.min = parseInt(inputRange.min) - TIME_ROUND_TO
        };

        const plus = document.getElementById("plus");
        plus.onclick = () => {
            inputRange.max = inputNumber.max = parseInt(inputRange.max) + TIME_ROUND_TO
        };

        const gregorianCalendarElements = {
            monthLabel: document.getElementById("gregorian-calendar-month"),
            weekLabels: document.getElementById("gregorian-calendar-week-labels"),
            boxes: document.getElementById("gregorian-calendar-boxes"),
            extraBoxesLabel: document.getElementById("gregorian-calendar-extra-label"),
            extraBoxes: document.getElementById("gregorian-calendar-extra-boxes"),
        };
        const internationalFixedCalendarElements = {
            monthLabel: document.getElementById("international-fixed-calendar-month"),
            weekLabels: document.getElementById("international-fixed-calendar-week-labels"),
            boxes: document.getElementById("international-fixed-calendar-boxes"),
            extraBoxesLabel: document.getElementById("international-fixed-calendar-extra-label"),
            extraBoxes: document.getElementById("international-fixed-calendar-extra-boxes"),
        };

        let clockLengthsMemo = {}

        const clockLengths = (scale) => {
            scale ||= 1

            // TODO? Measure whether memoizing this was actually worth it?
            if (!clockLengthsMemo[scale]) {
                const clockWidth = 100 * scale
                const clockHeight = 100 * scale
                const clockX = clockWidth/2
                const clockY = clockHeight/2
                const clockRadius = clockWidth * 0.45
                const clockNumberRadius = clockWidth * 0.375
                const clockInnerEdgeRadius = clockRadius * 0.95
                const clockSecondRadius = clockInnerEdgeRadius * 0.975
                const clockMinuteRadius = clockInnerEdgeRadius * 0.95
                const clockHourRadius = clockInnerEdgeRadius * 0.65

                clockLengthsMemo[scale] = {
                    clockWidth,
                    clockHeight,
                    clockX,
                    clockY,
                    clockRadius,
                    clockNumberRadius,
                    clockInnerEdgeRadius,
                    clockSecondRadius,
                    clockMinuteRadius,
                    clockHourRadius,
                }
            }

            return clockLengthsMemo[scale]
        }

        const digitalClock12 = document.getElementById("digital-clock-12")
        const digitalClock24 = document.getElementById("digital-clock-24")
        const digitalClockBase12 = document.getElementById("digital-clock-base-12")
        const digitalClock24Base12 = document.getElementById("digital-clock-24-base-12")
        const digitalClockBaseFactorial = document.getElementById("digital-clock-base-factorial")
        const digitalClock24BaseFactorial = document.getElementById("digital-clock-24-base-factorial")


        const verbalClock = document.getElementById("verbal-clock")
        const verbalTime = document.getElementById("verbal-time")
        const digitalDate = document.getElementById("digital-date")
        const digitalDateBaseDayOfMonthPlusOne = document.getElementById("digital-date-base-day-of-month-plus-one")
        const digitalIFCDateBaseDayOfMonthPlusOne = document.getElementById("digital-ifc-date-base-day-of-month-plus-one")
        const digitalDateBaseFactorial = document.getElementById("digital-date-base-factorial")
        const digitalIFCDateBaseFactorial = document.getElementById("digital-ifc-date-base-factorial")


        const metrologicalSeasonsNorth = document.getElementById("metrological-seasons-north")
        const metrologicalSeasonsSouth = document.getElementById("metrological-seasons-south")

        const synodicMonth = document.getElementById("synodic-month")
        const tropicalMonth = document.getElementById("tropical-month")
        const sideralMonth = document.getElementById("sideral-month")
        const anomalisticMonth = document.getElementById("anomalistic-month")
        const dragonicMonth = document.getElementById("dragonic-month")

        // Month durations as written in
        // https://archive.org/details/astronomicalalmanac1961/page/n117/mode/1up
        const SYNODIC_MONTH_IN_MILLIS =
            29 * Time.DAY_IN_MILLIS
            + 12 * Time.HOUR_IN_MILLIS
            + 44 * Time.MINUTE_IN_MILLIS
            + 2 * Time.SECOND_IN_MILLIS
            + 900

        const TROPICAL_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 7 * Time.HOUR_IN_MILLIS
            + 43 * Time.MINUTE_IN_MILLIS
            + 4 * Time.SECOND_IN_MILLIS
            + 700

        const SIDERAL_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 7 * Time.HOUR_IN_MILLIS
            + 43 * Time.MINUTE_IN_MILLIS
            + 11 * Time.SECOND_IN_MILLIS
            + 500

        const ANOMALISTIC_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 13 * Time.HOUR_IN_MILLIS
            + 18 * Time.MINUTE_IN_MILLIS
            + 33 * Time.SECOND_IN_MILLIS
            + 200

        const DRAGONIC_MONTH_IN_MILLIS =
            27 * Time.DAY_IN_MILLIS
            + 05 * Time.HOUR_IN_MILLIS
            + 05 * Time.MINUTE_IN_MILLIS
            + 35 * Time.SECOND_IN_MILLIS
            + 800

        const toAtMost10Chars = (n) => {
            if (n > 999_999_999) {
                return ">999999999"
            }
            if (n < -99_999_999) {
                return "<-999999999"
            }

            // Eight to allow for the minus sign and decimal point
            const eightSigFigs = n.toPrecision(8)

            if (eightSigFigs.includes("e")) {
                if (eightSigFigs.endsWith("e-7")) {
                    if (n > 0) {
                        return "0.000000" + eightSigFigs.substring(0, 1)
                    } else {
                        return "-0.000000" + eightSigFigs.substring(0, 1)
                    }
                }
                if (n > 0) {
                    return "0.0000001"
                } else {
                    return "-0.0000001"
                }
            }

            if (eightSigFigs.length > 10) {
                return eightSigFigs.substring(0,9)
            }

            return eightSigFigs
        }

        const getAnalogueClockCtx = (id, scale) => {
            scale ||= 1

            const lengths = clockLengths(scale)

            const canvas = document.getElementById(id)
            canvas.width = lengths.clockWidth
            canvas.height = lengths.clockHeight
            return {
                ctx: canvas.getContext("2d"),
                scale,
            };
        }

        const analogueClock12Ctx = getAnalogueClockCtx("analogue-clock-12")
        const analogueClock24Ctx = getAnalogueClockCtx("analogue-clock-24")
        const analogueClockBase12Ctx = getAnalogueClockCtx("analogue-clock-base-12")
        const analogueClock24Base12Ctx = getAnalogueClockCtx("analogue-clock-24-base-12")
        const analogueClockBaseFactorialCtx = getAnalogueClockCtx("analogue-clock-base-factorial")
        const analogueClock24BaseFactorialCtx = getAnalogueClockCtx("analogue-clock-24-base-factorial", 2)
        const analogueClock12ZeroOffsetCtx = getAnalogueClockCtx("analogue-clock-12-0-offset")

        const setFromTimeAndRender = (time) => {
            inputMode = PAUSED
            setFromTime(time)
            renderAt(new Date(time))
        }

        const clockNumberCenterXYForRadians = (radians, scale) => {
            scale ||= 1
            const lengths = clockLengths(scale)
            return [
                lengths.clockX + Math.cos(radians) * lengths.clockNumberRadius,
                lengths.clockY + Math.sin(radians) * lengths.clockNumberRadius,
            ]
        };

        function lastBase12Digit(x){
            x = Math.floor(x)
            x %= 12
            switch (x) {
                case 10:
                    return 'X'
                case 11:
                    return 'E'
                default:
                    return String(x)
            }
        }

        const clockTextForIndex = (index, divisor) => "" + (index === 0 ? divisor : index);

        const base12TextForIndex = (index, divisor) => {
            let n = index === 0 ? divisor : index

            let output = ""
            // Takes advantage of n being known to not be 0
            while (n > 0) {
                output = lastBase12Digit(n) + output

                n /= 12
                n = Math.floor(n)
            }

            return output
        }

        const factorialTextForIndex = (index, divisor) => {
            const n = index === 0 ? divisor : index

            return FactorialBase.stringOf(n)
        }

        const TAU = 2 * Math.PI

        const clockNumberCenterXYForIndex = ({index, divisor, offset, scale}) => {
            // Note that the negatives here do happen to work out
            offset = offset === undefined ? -3 : offset
            return clockNumberCenterXYForRadians(
                ((index + offset) % divisor) * (TAU / divisor),
                scale
            )
        }

        const range = (n) => {
            let output = new Array(n)

            for (let i = 0; i < n; i += 1) {
                output[i] = i
            }

            return output
        }

        const range12 = range(12)
        const range24 = range(24)

        // TODO? Memoize these?
        const twelveHourClockNumberXYForIndex = (index, scale) => {
            return clockNumberCenterXYForIndex({index, divisor: 12, scale})
        }

        const twelveHourZeroOffsetClockNumberXYForIndex = (index, scale) => {
            return clockNumberCenterXYForIndex({index, divisor: 12, offset: 0, scale})
        }

        const twentyFourHourClockNumberXYForIndex = (index, scale) => {
            return clockNumberCenterXYForIndex({index, divisor: 24, offset: -6, scale})
        }

        const twelveHourClockNumberXYs = (scale) => range12.map(n => twelveHourClockNumberXYForIndex(n, scale))
        const twelveHourZeroOffsetClockNumberXYs = (scale) => range12.map(n => twelveHourZeroOffsetClockNumberXYForIndex(n, scale))

        const twentyFourHourClockNumberXYs = (scale) => range24.map(n => twentyFourHourClockNumberXYForIndex(n, scale))

        const renderAt = (date) => {
            const time = date.getTime()
            setFromTime(time)
            raw.textContent = time.toLocaleString()
            utcString.textContent = date.toUTCString()

            const gregorianCalendarSpecs = Time.calculateCalendarSpecs(Time.GREGORIAN, date)

            applyCalendarSpecs(gregorianCalendarElements, gregorianCalendarSpecs)

            const internationalFixedCalendarBoxSpecs = Time.calculateCalendarSpecs(Time.INTERNATIONAL_FIXED, date)

            applyCalendarSpecs(internationalFixedCalendarElements, internationalFixedCalendarBoxSpecs)

            const hours = date.getUTCHours(); // 0 - 23
            const hours12 = hours % 12 // 0 - 12
            const minutes = date.getUTCMinutes(); // 0 - 59
            const seconds = date.getUTCSeconds(); // 0 - 59

            let h = padToTwoDigits(hours);
            let h12 = padToTwoDigits(hours12 === 0 ? 12 : hours12);
            let m = padToTwoDigits(minutes);
            let s = padToTwoDigits(seconds);

            digitalClock12.innerHTML = (hours >= 12 ? "Ë™" : "&nbsp;") + h12 + ":" + m + ":" + s
            digitalClock24.innerHTML = "&nbsp;" + h + ":" + m + ":" + s
            digitalClockBase12.innerHTML = (hours >= 12 ? "Ë™" : "&nbsp;") + padToTwoDigitsBase12(hours12 === 0 ? 12 : hours12) + ":" + padToTwoDigitsBase12(minutes) + ":" + padToTwoDigitsBase12(seconds)
            digitalClock24Base12.innerHTML = "&nbsp;" + padToTwoDigitsBase12(hours) + ":" + padToTwoDigitsBase12(minutes) + ":" + padToTwoDigitsBase12(seconds)
            digitalClockBaseFactorial.innerHTML = (hours >= 12 ? "Ë™" : "&nbsp;") + padToNDigitsBaseFactorial(3, hours12) + ":" + padToNDigitsBaseFactorial(4, minutes) + ":" + padToNDigitsBaseFactorial(4, seconds)
            digitalClock24BaseFactorial.innerHTML = "&nbsp;" + padToNDigitsBaseFactorial(3, hours) + ":" + padToNDigitsBaseFactorial(4, minutes) + ":" + padToNDigitsBaseFactorial(4, seconds)

            const nextHours12 = (hours12 + 1) % 12

            const signedFiveMinutesRounded = Math.round((((time % Time.HOUR_IN_MILLIS)/Time.HOUR_IN_MILLIS) * (60 / 5))) * 5

            let fiveMinutesRounded;
            if (signedFiveMinutesRounded > 0) {
                fiveMinutesRounded = signedFiveMinutesRounded
            } else {
                fiveMinutesRounded = 60 + signedFiveMinutesRounded
            }
            // For -0
            fiveMinutesRounded = Math.abs(fiveMinutesRounded)

            let timePhrase
            switch (fiveMinutesRounded) {
                default:
                    console.error("Got unexpected value for fiveMinutesRounded: "+ fiveMinutesRounded)
                    timePhrase = "Uh... half past a freckle"
                break
                case 0:
                    timePhrase = hoursToWord(hours12) + " o'clock"
                break
                case 5:
                    timePhrase = "Five past " + hoursToWord(hours12)
                break
                case 10:
                    timePhrase = "Ten past " + hoursToWord(hours12)
                break
                case 15:
                    timePhrase = "Quarter past " + hoursToWord(hours12)
                break
                case 20:
                    timePhrase = "Twenty past " + hoursToWord(hours12)
                break
                case 25:
                    timePhrase = "Twenty-Five past " + hoursToWord(hours12)
                break
                case 30:
                    timePhrase = "Half past " + hoursToWord(hours12)
                break
                case 35:
                    timePhrase = "Twenty-Five to " + hoursToWord(nextHours12)
                break
                case 40:
                    timePhrase = "Twenty to " + hoursToWord(nextHours12)
                break
                case 45:
                    timePhrase = "Quarter to " + hoursToWord(nextHours12)
                break
                case 50:
                    timePhrase = "Ten to " + hoursToWord(nextHours12)
                break
                case 55:
                    timePhrase = "Five to " + hoursToWord(nextHours12)
                break
                case 60:
                    timePhrase = hoursToWord(nextHours12) + " o'clock"
                break
            }

            verbalClock.textContent = timePhrase
            verbalTime.textContent = intToWords(time)

            renderClock({time, ctx: analogueClock12Ctx})
            renderClock({time, ctx: analogueClock24Ctx, numberXYs: twentyFourHourClockNumberXYs, divisor: 24})
            renderClock({time, ctx: analogueClockBase12Ctx, textForIndex: base12TextForIndex})
            renderClock({time, ctx: analogueClock24Base12Ctx, textForIndex: base12TextForIndex, numberXYs: twentyFourHourClockNumberXYs, divisor: 24})
            renderClock({time, ctx: analogueClockBaseFactorialCtx, textForIndex: factorialTextForIndex})
            renderClock({
                time,
                ctx: analogueClock24BaseFactorialCtx,
                textForIndex: factorialTextForIndex,
                numberXYs: twentyFourHourClockNumberXYs,
                divisor: 24,
                shouldRotateIndex: (i) => i === 23 || i === 0 || i === 1 || i === 11 || i === 12 || i === 13,
            })
            renderClock({time, ctx: analogueClock12ZeroOffsetCtx, numberXYs: twelveHourZeroOffsetClockNumberXYs, topOfClockShift: 0})

            const year = date.getUTCFullYear()
            const zeroIndexedMonth = date.getUTCMonth()
            const dayOfMonth = date.getUTCDate()

            const oneIndexedMonth = zeroIndexedMonth + 1

            digitalDate.textContent = `${year}-${padToTwoDigits(oneIndexedMonth)}-${padToTwoDigits(dayOfMonth)}`
            const base = dayOfMonth + 1
            digitalDateBaseDayOfMonthPlusOne.textContent = `${year.toString(base)}-${padStringToTwoDigits(oneIndexedMonth.toString(base))}-${padStringToTwoDigits(dayOfMonth.toString(base))}`

            const ifcMAndD = Time.ifcZeroIndexedMonthAndDay(date)

            const ifcOneIndexedMonth = ifcMAndD.zeroIndexedMonthNumber + 1

            const ifcBase = ifcMAndD.dayOfMonth + 1
            digitalIFCDateBaseDayOfMonthPlusOne.textContent = `${year.toString(ifcBase)}-${padStringToTwoDigits((ifcOneIndexedMonth).toString(ifcBase))}-${padStringToTwoDigits(ifcMAndD.dayOfMonth.toString(ifcBase))}`

            digitalDateBaseFactorial.textContent = `${FactorialBase.stringOf(year)}-${padToNDigitsBaseFactorial(3, oneIndexedMonth)}-${padToNDigitsBaseFactorial(5, dayOfMonth)}`
            digitalIFCDateBaseFactorial.textContent = `${FactorialBase.stringOf(year)}-${padToNDigitsBaseFactorial(3, ifcOneIndexedMonth)}-${padToNDigitsBaseFactorial(5, ifcMAndD.dayOfMonth)}`

            let northernMetrologicalSeason
            let southernMetrologicalSeason
            switch(zeroIndexedMonth) {
                default:
                    console.error("unexpected month for metrological seasons: " + zeroIndexedMonth)
                case 0: // Jan
                case 1: // Feb
                case 11: // December
                    northernMetrologicalSeason = "Winter"
                    southernMetrologicalSeason = "Summer"
                break
                case 2:
                case 3:
                case 4:
                    northernMetrologicalSeason = "Spring"
                    southernMetrologicalSeason = "Fall (Autumn)"
                break
                case 5:
                case 6:
                case 7:
                    northernMetrologicalSeason = "Summer"
                    southernMetrologicalSeason = "Winter"
                break
                case 8:
                case 9:
                case 10:
                    northernMetrologicalSeason = "Fall (Autumn)"
                    southernMetrologicalSeason = "Spring"
                break

            }

            metrologicalSeasonsNorth.textContent = northernMetrologicalSeason
            metrologicalSeasonsSouth.textContent = southernMetrologicalSeason

            // TODO align to conjunctions and use that to count and display the number of conjunctions
            synodicMonth.textContent = toAtMost10Chars(time / SYNODIC_MONTH_IN_MILLIS)

            // TODO align to equinoxes and use that to count and display the number of equinoxes
            tropicalMonth.textContent = toAtMost10Chars(time / TROPICAL_MONTH_IN_MILLIS)

            // TODO align to fixed star points and use that to count and display the number of fixed star points
            sideralMonth.textContent = toAtMost10Chars(time / SIDERAL_MONTH_IN_MILLIS)

            // TODO align to perigrees and use that to count and display the number of perigrees
            anomalisticMonth.textContent = toAtMost10Chars(time / ANOMALISTIC_MONTH_IN_MILLIS)

            // TODO align to node events and use that to count and display the number of node events
            dragonicMonth.textContent = toAtMost10Chars(time / DRAGONIC_MONTH_IN_MILLIS)
        }

        const hoursToWord = (n) => {
            n = n % 12
            if (n === 0) {
                n = 12
            }
            return intToWords(n)
        }

        const renderClock = ({time, ctx, divisor, numberXYs, topOfClockShift, textForIndex, shouldRotateIndex}) => {
            divisor ||= 12
            numberXYs ||= twelveHourClockNumberXYs
            topOfClockShift = topOfClockShift === undefined ? -0.25 : topOfClockShift
            textForIndex ||= clockTextForIndex
            shouldRotateIndex ||= () => false;

            const scale = ctx.scale
            ctx = ctx.ctx

            const lengths = clockLengths(scale)

            ctx.clearRect(0, 0, lengths.clockWidth, lengths.clockHeight)

            ctx.fillStyle = "#eee"
            ctx.beginPath();
            ctx.arc(lengths.clockX, lengths.clockY, lengths.clockRadius, 0, 2 * Math.PI)
            ctx.fill();

            ctx.lineWidth = 3;
            ctx.strokeStyle = '#5a7d8b';
            ctx.stroke();

            ctx.fillStyle = "#222"
            ctx.font = (6 * scale) + "px sans-serif";
            const numberXYsArray = numberXYs(scale)
            for (let i = 0; i < numberXYsArray.length; i += 1) {
                const [baseX, baseY] = numberXYsArray[i]

                const text = textForIndex(i, divisor)
                const metrics = ctx.measureText(text)


                if (shouldRotateIndex(i)) {
                    ctx.save();
                    ctx.translate(baseX, baseY);
                    ctx.rotate(Math.PI/2);
                    ctx.fillText(text, -metrics.width / 2, metrics.fontBoundingBoxDescent);
                    ctx.restore();
                } else {
                    ctx.fillText(text, baseX - metrics.width / 2, baseY + metrics.fontBoundingBoxDescent)
                }
            }

            const hourDivisor = 24 / divisor

            const hourFrac = (time % (Time.DAY_IN_MILLIS / hourDivisor)) / (Time.DAY_IN_MILLIS / hourDivisor)
            const minuteFrac = (time % Time.HOUR_IN_MILLIS) / Time.HOUR_IN_MILLIS
            const secondFrac = (time % Time.MINUTE_IN_MILLIS) / Time.MINUTE_IN_MILLIS

            ctx.lineWidth = 3;
            ctx.strokeStyle = '#3352e1';
            ctx.beginPath()
            ctx.moveTo(lengths.clockX, lengths.clockY)
            const hourAngle = (hourFrac + topOfClockShift) * TAU
            ctx.lineTo(lengths.clockX + Math.cos(hourAngle) * lengths.clockHourRadius, lengths.clockY + Math.sin(hourAngle) * lengths.clockHourRadius)
            ctx.stroke()

            ctx.lineWidth = 2;
            ctx.strokeStyle = '#5a7d8b';
            ctx.beginPath()
            ctx.moveTo(lengths.clockX, lengths.clockY)
            const minuteAngle = (minuteFrac + topOfClockShift) * TAU
            ctx.lineTo(lengths.clockX + Math.cos(minuteAngle) * lengths.clockMinuteRadius, lengths.clockY + Math.sin(minuteAngle) * lengths.clockMinuteRadius)
            ctx.stroke()

            ctx.lineWidth = 1;
            ctx.strokeStyle = '#de4949';
            ctx.beginPath()
            ctx.moveTo(lengths.clockX, lengths.clockY)
            const secondAngle = (secondFrac + topOfClockShift) * TAU
            ctx.lineTo(lengths.clockX + Math.cos(secondAngle) * lengths.clockSecondRadius, lengths.clockY + Math.sin(secondAngle) * lengths.clockSecondRadius)
            ctx.stroke()
        }

        const intToWords = (n) => {
            let output = ""

            if (n < 0) {
                output += "Minus "
            }

            n = Math.abs(n)

            for (let [roundValue, word] of [
                // This covers up to Number.MAX_SAFE_INTEGER, which seems as good a place to stop as any
                [1_000_000_000_000_000_000, "Quintillion"],
                [1_000_000_000_000_000, "Quadrillion"],
                [1_000_000_000_000, "Trillion"],
                [1_000_000_000, "Billion"],
                [1_000_000, "Million"],
                [1000, "Thousand"],
                [100, "Hundred"]
            ]) {
                if (n === roundValue) {
                    output += intToWords(1) + " " + word
                    return output
                } else if (n > roundValue) {
                    const leadingDigits = Math.floor(n / roundValue)
                    output += intToWords(leadingDigits) + " " + word + " "
                    n -= leadingDigits * roundValue
                    if (n === 0) {
                        return output
                    }
                }
            }

            for (let [multipleOfTen, word] of [[90, "Ninety"], [80, "Eighty"], [70, "Seventy"], [60, "Sixty"], [50, "Fifty"], [40, "Forty"], [30, "Thirty"], [20, "Twenty"]]) {
                if (n === multipleOfTen) {
                    output += word
                    return output
                } else if (n > multipleOfTen) {
                    output += intToWords(multipleOfTen) + '-' + intToWords(n % multipleOfTen)
                    return output
                }
            }
            switch (n) {
                default:
                    console.error("Unhandled case in intToWords: " + n)
                    return "" + n
                case 0:
                    output += "Zero"
                break
                case 1:
                    output += "One"
                break
                case 2:
                    output += "Two"
                break
                case 3:
                    output += "Three"
                break
                case 4:
                    output += "Four"
                break
                case 5:
                    output += "Five"
                break
                case 6:
                    output += "Six"
                break
                case 7:
                    output += "Seven"
                break
                case 8:
                    output += "Eight"
                break
                case 9:
                    output += "Nine"
                break
                case 10:
                    output += "Ten"
                break
                case 11:
                    output += "Eleven"
                break
                case 12:
                    output += "Twelve"
                break
                case 13:
                    output += "Thirteen"
                break
                case 14:
                    output += "Fourteen"
                break
                case 15:
                    output += "Fifteen"
                break
                case 16:
                    output += "Sixteen"
                break
                case 17:
                    output +="Seventeen"
                break
                case 18:
                    output += "Eighteen"
                break
                case 19:
                    output += "Nineteen"
                break
            }

            return output
        }

        const padToTwoDigits = (n) => {
            return (n < 10 ? "0" : "") + n
        }

        const padToTwoDigitsBase12 = (n) => {
            return (n < 12 ? "0" : lastBase12Digit(n/12)) + lastBase12Digit(n)
        }

        const padToNDigitsBaseFactorial = (digits, toPad) => {
            let output = FactorialBase.stringOf(toPad)

            while (output.length < digits) {
                output = "0" + output
            }

            return output
        }

        const padStringToTwoDigits = (s) => {
            return (s.length === 0 ? "00" : (s.length === 1 ? "0" : "")) + s
        }

        const playPause = document.getElementById("play-pause");
        playPause.onclick = () => {
            switch (inputMode) {
                case RUNNING:
                    inputMode = PAUSED
                break
                case PAUSED:
                    inputMode = RUNNING
                    renderStep()
                break
            }
        };

        const applyCalendarSpecs = (
            {
                monthLabel,
                weekLabels,
                boxes,
                extraBoxesLabel,
                extraBoxes,
            },
            {
                monthText,
                boxSpecs,
                appearance,
            }
        ) => {
            monthLabel.innerHTML = monthText

            if (appearance === Time.HIDE_WEEK_ROW) {
                weekLabels.style.display = "none"
            }

            let len = boxSpecs.length
            if (appearance === Time.LAST_DAY_OUTSIDE_WEEK) {
                len -= 1
            }

            let newBoxes = ''
            for (let i = 0; i < len; i += 1) {
                newBoxes += boxHtml(boxSpecs[i])
            }
            boxes.innerHTML = newBoxes

            if (appearance === Time.LAST_DAY_OUTSIDE_WEEK) {
                extraBoxesLabel.style.display = "block"
                extraBoxesLabel.textContent = "No Week Day"
                extraBoxes.style.display = "block"
                extraBoxes.innerHTML = boxHtml(boxSpecs[boxSpecs.length - 1])
            } else {
                extraBoxesLabel.style.display = "none"
                extraBoxes.style.display = "none"
            }
        }

        const boxHtml = (
            {text, kind, linkedTime}
        ) => {
            let className;
                switch (kind) {
                    default:
                        console.error("No classname for spec kind: " + kind)
                        // fallthrough
                    case Time.OTHER_MONTH:
                        className = "other-month"
                    break
                    case Time.CURRENT_MONTH:
                        className = "current-month"
                    break
                    case Time.CURRENT_DAY:
                        className = "current-day"
                    break
                }

            return `<div class="${className}" onclick="setFromTimeAndRender(${linkedTime})">
                ${text}
            </div>`
        }


        const renderStep = () => {
            renderAt(new Date())

            switch (inputMode) {
                case RUNNING:
                    requestAnimationFrame(renderStep)
                break
                case PAUSED:
                    // don't do another frame
                break
            }

        }
        renderStep()

        // TODO show a version of the clock on xkcd.com/now
        // TODO show a large analogue clock with words for numbers.
        // TODO show a playing card for each of the 52 weeks
        //   https://en.wikipedia.org/wiki/Playing_cards_in_Unicode
        // TODO show a gregorian calendar using a subset of the years that covers the possible years
        // TODO show position in the Sexagenary cycle/ganzhi
        //    Any other similar cycles like this? Mayan calendar maybe?
        // TODO show a continued Julian calendar
        // TODO show French Republican decimal time
        // TODO show French Republican Calendar
        // TODO show Swatch Internet time
        // TODO show a "digital analogue" clock that merely prints the angle of the hands
        //  I guess a analogue digital clock would be one of those ones where the digits are shown on cards that flip over?
        // TODO add a analogue clock that has a minute hand, a millenium hand, and an eon hand.
        //   Can probably call an eon the average langth of a geologic eon, or since wikipedia says "half a billion years or more", just use a nice round number close to half a billion years
        // TODO? invent and show an "analogue date"?
        //     I guess numbers for the months? Maybe this would only make sense for a calandar with truly fixed length months? What if a "year" is 4 years to bake in leap year stuff?
        // TODO show phases of the moon with symbols, as seen in northern and southern hemispheres (This is apparently hard to do accurately!)
        // TODO? show if the current day or other time period is mildy interesting in a different calendar than usual?
        //    For example, IFC April fool's day, King of hearts week
        //    But is there enough of these to be worth it? There are more of these if there's more calendars

        // TODO? add labels to more of the timepieces, maybe making them optional?

        // TODO a convenient way to show only a subset of the available time displays
        //    A set of nice radio buttons like all, weird, standard etc.
        //    A way to easily select one digital clock, one analogue clock and one calendar would be good.
    </script>
</body>
</html>
